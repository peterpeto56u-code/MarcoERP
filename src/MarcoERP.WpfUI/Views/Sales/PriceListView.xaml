<UserControl x:Class="MarcoERP.WpfUI.Views.Sales.PriceListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:MarcoERP.WpfUI.Common"
             FlowDirection="RightToLeft"
             local:LoadedCommandBehavior.Command="{Binding LoadCommand}">

    <UserControl.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}" />
    </UserControl.InputBindings>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- â•â•â•â•â•â• Row 0: Title + Toolbar â•â•â•â•â•â• -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <DockPanel>
                <TextBlock Text="Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" Style="{StaticResource PageTitle}"
                           DockPanel.Dock="Right" Margin="0" VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource SuccessBrush}" Foreground="White"
                            Command="{Binding NewCommand}" ToolTip="Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center" />
                            <TextBlock Text="Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource PrimaryBrush}" Foreground="White"
                            Command="{Binding SaveCommand}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                            ToolTip="Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ContentSave" VerticalAlignment="Center" />
                            <TextBlock Text="Ø­ÙØ¸" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding CancelCommand}"
                            Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                            ToolTip="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" Margin="4,0">
                        <TextBlock Text="Ø¥Ù„ØºØ§Ø¡" />
                    </Button>
                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                            Foreground="{StaticResource DangerBrush}"
                            Command="{Binding DeleteCommand}" ToolTip="Ø­Ø°Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Delete" VerticalAlignment="Center" />
                            <TextBlock Text="Ø­Ø°Ù" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding LoadCommand}" ToolTip="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Margin="4,0">
                        <materialDesign:PackIcon Kind="Refresh" />
                    </Button>
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding PrintCommand}" ToolTip="Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± PDF" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Printer" VerticalAlignment="Center" />
                            <TextBlock Text="Ø·Ø¨Ø§Ø¹Ø©" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- â•â•â•â•â•â• Row 1: Error Bar â•â•â•â•â•â• -->
        <Border Grid.Row="1" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="10,6" Margin="8,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}"
                           Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- â•â•â•â•â•â• Row 2: Header â€” Price List Selector + Form Fields â•â•â•â•â•â• -->
        <Border Grid.Row="2" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Price List Selector -->
                <TextBlock Grid.Column="0" Text="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:" VerticalAlignment="Center"
                           FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,8,0" />
                <ComboBox Grid.Column="1" ItemsSource="{Binding AllPriceLists}"
                          SelectedItem="{Binding SelectedPriceList, Mode=TwoWay}"
                          DisplayMemberPath="NameAr" FontSize="13" Margin="0,0,12,0"
                          materialDesign:HintAssist.Hint="Ø§Ø®ØªØ± Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø±" MinWidth="180" />

                <!-- Name Arabic -->
                <TextBlock Grid.Column="2" Text="Ø§Ù„Ø§Ø³Ù…:" VerticalAlignment="Center"
                           FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,8,0" />
                <TextBox Grid.Column="3" Text="{Binding FormNameAr, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsEditing}" FontSize="13" Padding="6,4" Margin="0,0,12,0"
                         materialDesign:HintAssist.Hint="Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" />

                <!-- Valid From -->
                <TextBlock Grid.Column="4" Text="Ù…Ù†:" VerticalAlignment="Center"
                           FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,4,0" />
                <DatePicker Grid.Column="5" SelectedDate="{Binding FormValidFrom}"
                            IsEnabled="{Binding IsEditing}" FontSize="12" Margin="0,0,12,0" Width="120" />

                <!-- Valid To -->
                <TextBlock Grid.Column="6" Text="Ø¥Ù„Ù‰:" VerticalAlignment="Center"
                           FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,4,0" />
                <DatePicker Grid.Column="7" SelectedDate="{Binding FormValidTo}"
                            IsEnabled="{Binding IsEditing}" FontSize="12" Width="120" />
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â• Row 3: Filter Bar + Bulk Actions â•â•â•â•â•â• -->
        <Border Grid.Row="3" Style="{StaticResource CardPanel}" Padding="10,6" Margin="0,0,0,4">
            <DockPanel>
                <!-- Bulk action buttons on the left -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Command="{Binding SelectAllCommand}"
                            ToolTip="ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©" Margin="2,0" Padding="6,2">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="CheckboxMultipleMarked" VerticalAlignment="Center" Width="18" Height="18" />
                            <TextBlock Text="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Command="{Binding DeselectAllCommand}"
                            ToolTip="Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©" Margin="2,0" Padding="6,2">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="CheckboxMultipleBlankOutline" VerticalAlignment="Center" Width="18" Height="18" />
                            <TextBlock Text="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Command="{Binding CopyDefaultPricesCommand}"
                            ToolTip="Ù†Ø³Ø® Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙƒÙ„ ØµÙ†Ù Ù…Ø­Ø¯Ø¯" Margin="2,0" Padding="6,2">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ContentCopy" VerticalAlignment="Center" Width="18" Height="18" />
                            <TextBlock Text="Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Filters on the right -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <!-- Search -->
                    <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                             materialDesign:HintAssist.Hint="ðŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..."
                             FontSize="12" Padding="6,4" MinWidth="180" Margin="0,0,8,0" />

                    <!-- Supplier Filter -->
                    <ComboBox ItemsSource="{Binding Suppliers}"
                              SelectedValue="{Binding FilterSupplierId, Mode=TwoWay}"
                              SelectedValuePath="Id" DisplayMemberPath="NameAr"
                              materialDesign:HintAssist.Hint="Ø§Ù„Ù…ÙˆØ±Ø¯"
                              FontSize="12" MinWidth="140" Margin="0,0,8,0"
                              IsEditable="False" materialDesign:ComboBoxAssist.ShowSelectedItem="True" />

                    <!-- Category Filter -->
                    <ComboBox ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding FilterCategoryName, Mode=TwoWay}"
                              materialDesign:HintAssist.Hint="Ø§Ù„ÙØ¦Ø©"
                              FontSize="12" MinWidth="120" Margin="0,0,4,0"
                              IsEditable="False" materialDesign:ComboBoxAssist.ShowSelectedItem="True" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- â•â•â•â•â•â• Row 4: Excel-like DataGrid â•â•â•â•â•â• -->
        <Border Grid.Row="4" Style="{StaticResource CardPanel}" Margin="0,0,0,4">
            <DataGrid ItemsSource="{Binding FilteredItems}"
                      AutoGenerateColumns="False" IsReadOnly="False"
                      CanUserAddRows="False" CanUserDeleteRows="False"
                      SelectionMode="Single" GridLinesVisibility="All"
                      HeadersVisibility="Column" FontSize="12"
                      RowHeight="32" ColumnHeaderHeight="34" BorderThickness="0"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      EnableRowVirtualization="True"
                      ScrollViewer.CanContentScroll="True"
                      materialDesign:DataGridAssist.CellPadding="8 4"
                      materialDesign:DataGridAssist.ColumnHeaderPadding="8 6">

                <DataGrid.Columns>
                    <!-- 1. Checkbox (IsSelected) -->
                    <DataGridTemplateColumn Header="âœ“" Width="45" CanUserResize="False" CanUserSort="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- 2. Product Code -->
                    <DataGridTextColumn Header="Ø§Ù„ÙƒÙˆØ¯" Binding="{Binding ProductCode}" Width="90"
                                        IsReadOnly="True" />

                    <!-- 3. Product Name -->
                    <DataGridTextColumn Header="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" Binding="{Binding ProductName}" Width="*"
                                        IsReadOnly="True" />

                    <!-- 4. Category -->
                    <DataGridTextColumn Header="Ø§Ù„ÙØ¦Ø©" Binding="{Binding CategoryName}" Width="120"
                                        IsReadOnly="True" />

                    <!-- 5. Supplier -->
                    <DataGridTextColumn Header="Ø§Ù„Ù…ÙˆØ±Ø¯" Binding="{Binding SupplierName}" Width="130"
                                        IsReadOnly="True" />

                    <!-- 6. Default Sale Price (read-only) -->
                    <DataGridTextColumn Header="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" Width="100" IsReadOnly="True">
                        <DataGridTextColumn.Binding>
                            <Binding Path="DefaultSalePrice" StringFormat="N2" />
                        </DataGridTextColumn.Binding>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FlowDirection" Value="LeftToRight" />
                                <Setter Property="TextAlignment" Value="Right" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>

                    <!-- 7. Price List Price (EDITABLE) -->
                    <DataGridTemplateColumn Header="Ø³Ø¹Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" Width="110" CanUserSort="True" SortMemberPath="PriceListPrice">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PriceListPrice, StringFormat=N2}"
                                           FlowDirection="LeftToRight" TextAlignment="Right"
                                           VerticalAlignment="Center" Padding="4,0" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <TextBox Text="{Binding PriceListPrice, UpdateSourceTrigger=LostFocus, StringFormat=N2}"
                                         FlowDirection="LeftToRight" TextAlignment="Right"
                                         VerticalAlignment="Center" Padding="4,2"
                                         BorderThickness="1" FontSize="12" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- 8. Min Quantity (EDITABLE) -->
                    <DataGridTemplateColumn Header="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰" Width="90" CanUserSort="True" SortMemberPath="MinQuantity">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding MinQuantity, StringFormat=N0}"
                                           FlowDirection="LeftToRight" TextAlignment="Right"
                                           VerticalAlignment="Center" Padding="4,0" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <TextBox Text="{Binding MinQuantity, UpdateSourceTrigger=LostFocus, StringFormat=N0}"
                                         FlowDirection="LeftToRight" TextAlignment="Right"
                                         VerticalAlignment="Center" Padding="4,2"
                                         BorderThickness="1" FontSize="12" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- â•â•â•â•â•â• Row 5: Status Bar â•â•â•â•â•â• -->
        <Border Grid.Row="5" Padding="10,6" Margin="8,0,8,0">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <TextBlock FontSize="12" Foreground="{StaticResource SubtitleBrush}">
                        <Run Text="Ø§Ù„Ù…Ø­Ø¯Ø¯:" />
                        <Run Text="{Binding SelectedCount, Mode=OneWay}" FontWeight="SemiBold" />
                        <Run Text=" | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:" />
                        <Run Text="{Binding TotalVisible, Mode=OneWay}" FontWeight="SemiBold" />
                    </TextBlock>
                </StackPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SubtitleBrush}" FontSize="12" />
                    <ProgressBar IsIndeterminate="{Binding IsBusy}"
                                 Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 Height="3" Width="100" Margin="16,0,0,0" />
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

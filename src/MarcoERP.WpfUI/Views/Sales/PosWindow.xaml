<Window x:Class="MarcoERP.WpfUI.Views.Sales.PosWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:local="clr-namespace:MarcoERP.WpfUI.Common"
        Title="نقطة البيع — MarcoERP" WindowState="Maximized" WindowStyle="None"
        FlowDirection="RightToLeft" FontFamily="Segoe UI" FontSize="14"
        Background="{StaticResource BackgroundBrush}"
    local:LoadedCommandBehavior.Command="{Binding InitializeCommand}"
        local:EnterKeyFocusBehavior.TargetElement="{Binding ElementName=BarcodeInput}"
        FocusManager.FocusedElement="{Binding ElementName=BarcodeInput}">

    <Window.InputBindings>
        <KeyBinding Key="F1" Command="{Binding RefreshCacheCommand}" />
        <KeyBinding Key="F4" Command="{Binding ShowPaymentCommand}" />
        <KeyBinding Key="F9" Command="{Binding CompleteSaleCommand}" />
        <KeyBinding Key="Escape" Command="{Binding CancelCartCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />   <!-- Header bar -->
            <RowDefinition Height="Auto" />   <!-- Error bar -->
            <RowDefinition Height="*" />       <!-- Main content -->
            <RowDefinition Height="Auto" />   <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════════════════
             Row 0: Header Bar
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryDarkBrush}" Padding="12,8">
            <DockPanel>
                <!-- Right: Title + Session Info -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="PointOfSale" Width="28" Height="28" Foreground="White"
                                             VerticalAlignment="Center" Margin="0,0,8,0" />
                    <TextBlock Text="نقطة البيع" FontSize="22" FontWeight="Bold" Foreground="White"
                               VerticalAlignment="Center" Margin="0,0,16,0" />
                    <TextBlock Text="{Binding SessionInfo}" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12"
                               VerticalAlignment="Center" />
                </StackPanel>

                <!-- Left: Action Buttons -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" HorizontalAlignment="Left"
                            VerticalAlignment="Center">
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Foreground="White"
                            Command="{Binding OpenSessionCommand}" Margin="2,0"
                            ToolTip="فتح جلسة جديدة">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Play" VerticalAlignment="Center" />
                            <TextBlock Text="فتح جلسة" Margin="4,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Foreground="#FFCDD2"
                            Command="{Binding CloseSessionCommand}" Margin="2,0"
                            ToolTip="إغلاق الجلسة الحالية">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Stop" VerticalAlignment="Center" />
                            <TextBlock Text="إغلاق جلسة" Margin="4,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"
                               Margin="8,4" Background="#546E7A" />
                    <Button Style="{StaticResource MaterialDesignFlatButton}" Foreground="White"
                            Command="{Binding RefreshCacheCommand}" ToolTip="تحديث الأصناف (F1)">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Refresh" VerticalAlignment="Center" />
                            <TextBlock Text="F1" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                            <Button Style="{StaticResource MaterialDesignFlatButton}" Foreground="White"
                                local:CloseWindowBehavior.IsEnabled="True"
                                ToolTip="خروج">
                        <materialDesign:PackIcon Kind="ExitToApp" Width="22" Height="22" />
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ═══════════════════════════════════════════════════════
             Row 1: Error / Success Bar
             ═══════════════════════════════════════════════════════ -->
        <StackPanel Grid.Row="1">
            <!-- Error -->
            <Border Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="0" Padding="12,6"
                    Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}" FontSize="12"
                               Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
                </StackPanel>
            </Border>
            <!-- Status -->
            <Border Background="#E8F5E9" CornerRadius="0" Padding="12,6"
                    Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="CheckCircle" Foreground="#388E3C" VerticalAlignment="Center" />
                    <TextBlock Text="{Binding StatusMessage}" Foreground="#388E3C" FontSize="12"
                               Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- ═══════════════════════════════════════════════════════
             Row 2: Main Content (3 columns)
             ═══════════════════════════════════════════════════════ -->
        <Grid Grid.Row="2" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1.6*" MinWidth="500" />  <!-- Cart -->
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" MinWidth="320" />     <!-- Payment / Info Panel -->
            </Grid.ColumnDefinitions>

            <!-- ═══════════════ LEFT: Search + Cart ═══════════════ -->
            <DockPanel Grid.Column="0">

                <!-- Search Bar (top) -->
                <Border DockPanel.Dock="Top" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
                    <DockPanel>
                        <materialDesign:PackIcon Kind="Barcode" Width="28" Height="28"
                                                  Foreground="{StaticResource PrimaryBrush}"
                                                  VerticalAlignment="Center" DockPanel.Dock="Right"
                                                  Margin="0,0,8,0" />
                        <TextBox x:Name="BarcodeInput"
                                 materialDesign:HintAssist.Hint="أدخل الباركود أو اسم الصنف..."
                                 materialDesign:HintAssist.IsFloating="False"
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                 local:TextBoxEnterCommandBehavior.Command="{Binding ScanCommand}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 FontSize="18" Padding="8,6"
                                 VerticalAlignment="Center" />
                    </DockPanel>
                </Border>

                <!-- Search Results Popup -->
                <Popup x:Name="SearchPopup" PlacementTarget="{Binding ElementName=BarcodeInput}"
                       Placement="Bottom" StaysOpen="False"
                      IsOpen="{Binding HasSearchResults, Mode=OneWay}"
                       AllowsTransparency="True" PopupAnimation="Fade">
                    <Border Background="White" BorderBrush="#BDBDBD" BorderThickness="1"
                            CornerRadius="4" MaxHeight="250" Width="500"
                            Effect="{StaticResource MaterialDesignShadowDepth2}">
                        <ListBox ItemsSource="{Binding SearchResults}"
                                 DisplayMemberPath="NameAr"
                                 FontSize="14">
                            <ListBox.InputBindings>
                                <MouseBinding MouseAction="LeftDoubleClick"
                                              Command="{Binding AddToCartCommand}"
                                              CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                            </ListBox.InputBindings>
                        </ListBox>
                    </Border>
                </Popup>

                <!-- Totals Summary Bar -->
                <Border DockPanel.Dock="Bottom" Style="{StaticResource CardPanel}" Padding="12,10" Margin="0,4,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="1.5*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                            <TextBlock Text="الأصناف" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartItemCount}" FontWeight="SemiBold" FontSize="15" HorizontalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                            <TextBlock Text="الإجمالي" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartSubtotal, StringFormat=N2}" FontWeight="SemiBold" FontSize="15" HorizontalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                            <TextBlock Text="الخصم" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartDiscount, StringFormat=N2}" FontWeight="SemiBold" FontSize="15" Foreground="{StaticResource WarningBrush}" HorizontalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                            <TextBlock Text="الضريبة" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartVat, StringFormat=N2}" FontWeight="SemiBold" FontSize="15" Foreground="{StaticResource DangerBrush}" HorizontalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                            <TextBlock Text="الربح" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartProfit, StringFormat=N2}" FontWeight="SemiBold" FontSize="15" Foreground="{StaticResource SuccessBrush}" HorizontalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Grid.Column="5" HorizontalAlignment="Center">
                            <TextBlock Text="الصافي" FontSize="11" Foreground="Gray" HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding CartNetTotal, StringFormat=N2}" FontWeight="ExtraBold" FontSize="22"
                                       Foreground="{StaticResource PrimaryBrush}" HorizontalAlignment="Center" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Cart DataGrid -->
                <Border Style="{StaticResource CardPanel}" Padding="8">
                    <DataGrid ItemsSource="{Binding CartItems}"
                              SelectedItem="{Binding SelectedCartItem, Mode=TwoWay}"
                              AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" CanUserDeleteRows="False"
                              SelectionMode="Single" GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column" FontSize="14"
                              RowHeight="40" ColumnHeaderHeight="42" BorderThickness="0"
                              materialDesign:DataGridAssist.CellPadding="10 6"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="10 8"
                              VerticalScrollBarVisibility="Auto"
                              Background="White" RowBackground="White" AlternatingRowBackground="#FAFAFA">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="الكود" Binding="{Binding ProductCode}" Width="80" />
                            <DataGridTextColumn Header="الصنف" Binding="{Binding ProductNameAr}" Width="*" MinWidth="160" />
                            <DataGridTextColumn Header="الوحدة" Binding="{Binding UnitNameAr}" Width="80" />
                            <DataGridTextColumn Header="الكمية" Binding="{Binding Quantity, StringFormat=N3}" Width="70" />
                            <DataGridTextColumn Header="السعر" Binding="{Binding UnitPrice, StringFormat=N2}" Width="85" />
                            <DataGridTextColumn Header="خصم %" Binding="{Binding DiscountPercent, StringFormat=N1}" Width="60" />
                            <DataGridTextColumn Header="الضريبة" Binding="{Binding VatAmount, StringFormat=N2}" Width="80" />
                            <DataGridTextColumn Header="الإجمالي" Binding="{Binding TotalWithVat, StringFormat=N2}" Width="95">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontWeight" Value="Bold" />
                                        <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="الربح" Binding="{Binding ProfitAmount, StringFormat=N2}" Width="80">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTemplateColumn Header="" Width="36">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Style="{StaticResource MaterialDesignFlatButton}"
                                                Command="{Binding DataContext.RemoveFromCartCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                Padding="2" Height="28" Width="28" Foreground="{StaticResource DangerBrush}" ToolTip="حذف">
                                            <materialDesign:PackIcon Kind="Delete" Width="16" Height="16" />
                                        </Button>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
            </DockPanel>

            <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch" />

            <!-- ═══════════════ RIGHT: Payment + Actions ═══════════════ -->
            <DockPanel Grid.Column="2">

                <!-- Shortcut Buttons (top) -->
                <Border DockPanel.Dock="Top" Style="{StaticResource CardPanel}" Padding="10,8" Margin="0,0,0,4">
                    <UniformGrid Rows="1" Columns="4">
                        <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource InfoBrush}" Foreground="White"
                                Command="{Binding ShowPaymentCommand}" Margin="3,0" Height="44" ToolTip="F4 — الدفع">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="CashRegister" VerticalAlignment="Center" />
                                <TextBlock Text="دفع F4" Margin="4,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource SuccessBrush}" Foreground="White"
                                Command="{Binding CompleteSaleCommand}" Margin="3,0" Height="44" ToolTip="F9 — تأكيد">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="CheckBold" VerticalAlignment="Center" />
                                <TextBlock Text="تأكيد F9" Margin="4,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource WarningBrush}" Foreground="White"
                                Command="{Binding CancelCartCommand}" Margin="3,0" Height="44" ToolTip="Esc — إلغاء">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Cancel" VerticalAlignment="Center" />
                                <TextBlock Text="إلغاء Esc" Margin="4,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource DangerBrush}" Foreground="White"
                                Command="{Binding RemoveFromCartCommand}" Margin="3,0" Height="44" ToolTip="حذف البند المحدد">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Delete" VerticalAlignment="Center" />
                                <TextBlock Text="حذف" Margin="4,0,0,0" VerticalAlignment="Center" FontWeight="SemiBold" />
                            </StackPanel>
                        </Button>
                    </UniformGrid>
                </Border>

                <!-- Customer Selection -->
                <Border DockPanel.Dock="Top" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
                    <DockPanel>
                        <materialDesign:PackIcon Kind="AccountCircle" Width="24" Height="24"
                                                  Foreground="{StaticResource PrimaryBrush}"
                                                  VerticalAlignment="Center" DockPanel.Dock="Right" Margin="0,0,8,0" />
                        <TextBlock Text="{Binding CustomerName}" VerticalAlignment="Center"
                                   FontSize="16" FontWeight="SemiBold" />
                    </DockPanel>
                </Border>

                <!-- Payment Panel (conditionally visible) -->
                <Border DockPanel.Dock="Top" Style="{StaticResource CardPanel}" Padding="16"
                        Visibility="{Binding IsPaymentPanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="الدفع" Style="{StaticResource SectionTitle}" Margin="0,0,0,12" />

                        <!-- Cash -->
                        <DockPanel Margin="0,4">
                            <materialDesign:PackIcon Kind="Cash" Width="22" Height="22" Foreground="{StaticResource SuccessBrush}"
                                                      VerticalAlignment="Center" DockPanel.Dock="Right" Margin="0,0,8,0" />
                            <TextBox materialDesign:HintAssist.Hint="نقدي"
                                     materialDesign:HintAssist.IsFloating="True"
                                     Text="{Binding CashAmount, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     FontSize="18" FontWeight="SemiBold" Padding="8,4" />
                        </DockPanel>

                        <!-- Card -->
                        <DockPanel Margin="0,4">
                            <materialDesign:PackIcon Kind="CreditCard" Width="22" Height="22" Foreground="{StaticResource InfoBrush}"
                                                      VerticalAlignment="Center" DockPanel.Dock="Right" Margin="0,0,8,0" />
                            <TextBox materialDesign:HintAssist.Hint="بطاقة"
                                     materialDesign:HintAssist.IsFloating="True"
                                     Text="{Binding CardAmount, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     FontSize="16" Padding="8,4" />
                        </DockPanel>

                        <!-- Card Reference -->
                        <TextBox materialDesign:HintAssist.Hint="رقم مرجع البطاقة"
                                 materialDesign:HintAssist.IsFloating="True"
                                 Text="{Binding CardReferenceNumber, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 FontSize="12" Padding="6,3" Margin="0,2" />

                        <!-- On Account -->
                        <DockPanel Margin="0,4">
                            <materialDesign:PackIcon Kind="AccountClock" Width="22" Height="22" Foreground="{StaticResource WarningBrush}"
                                                      VerticalAlignment="Center" DockPanel.Dock="Right" Margin="0,0,8,0" />
                            <TextBox materialDesign:HintAssist.Hint="آجل"
                                     materialDesign:HintAssist.IsFloating="True"
                                     Text="{Binding OnAccountAmount, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     FontSize="16" Padding="8,4" />
                        </DockPanel>

                        <Separator Margin="0,10" />

                        <!-- Payment Summary -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="المطلوب:" FontSize="14" Foreground="Gray" VerticalAlignment="Center" />
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CartNetTotal, StringFormat=N2}"
                                       FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" HorizontalAlignment="Left" VerticalAlignment="Center" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="المدفوع:" FontSize="14" Foreground="Gray" VerticalAlignment="Center" Margin="0,4" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TotalPaid, StringFormat=N2}"
                                       FontSize="16" FontWeight="SemiBold" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,4" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="الباقي:" FontSize="14" Foreground="Gray" VerticalAlignment="Center" Margin="0,4" />
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ChangeAmount, StringFormat=N2}"
                                       FontSize="20" FontWeight="ExtraBold" Foreground="{StaticResource SuccessBrush}" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="0,4" />
                        </Grid>

                        <!-- Quick Pay Buttons -->
                        <UniformGrid Rows="1" Columns="2" Margin="0,12,0,0">
                            <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource SuccessBrush}" Foreground="White"
                                    Command="{Binding CashFullCommand}" Margin="3,0" Height="38">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Cash" VerticalAlignment="Center" />
                                    <TextBlock Text="نقدي كامل" Margin="4,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource MaterialDesignRaisedButton}" Background="{StaticResource InfoBrush}" Foreground="White"
                                    Command="{Binding CompleteSaleCommand}" Margin="3,0" Height="38">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="CheckBold" VerticalAlignment="Center" />
                                    <TextBlock Text="تأكيد البيع" Margin="4,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </UniformGrid>
                    </StackPanel>
                </Border>

                <!-- Big Net Total Display (when payment panel hidden) -->
                <Border Style="{StaticResource CardPanel}" Padding="20"
                        Visibility="{Binding IsPaymentPanelVisible, Converter={StaticResource InverseBoolToVisConverter}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="الصافي المطلوب" FontSize="18" Foreground="Gray"
                                   HorizontalAlignment="Center" Margin="0,0,0,8" />
                        <TextBlock Text="{Binding CartNetTotal, StringFormat=N2}" FontSize="48" FontWeight="ExtraBold"
                                   Foreground="{StaticResource PrimaryBrush}" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding CartItemCount, StringFormat={}{0} صنف}" FontSize="14" Foreground="Gray"
                                   HorizontalAlignment="Center" Margin="0,8,0,0" />
                    </StackPanel>
                </Border>
            </DockPanel>
        </Grid>

        <!-- ═══════════════════════════════════════════════════════
             Row 3: Status Bar
             ═══════════════════════════════════════════════════════ -->
        <Border Grid.Row="3" Background="#263238" Padding="12,6">
            <DockPanel>
                <TextBlock DockPanel.Dock="Right" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12" VerticalAlignment="Center">
                    <Run Text="F1 تحديث" /><Run Text="  |  " />
                    <Run Text="F4 دفع" /><Run Text="  |  " />
                    <Run Text="F9 تأكيد" /><Run Text="  |  " />
                    <Run Text="Esc إلغاء" />
                </TextBlock>
                <ProgressBar IsIndeterminate="{Binding IsBusy}" Height="3" Width="100"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                             DockPanel.Dock="Left" Margin="0,0,12,0" VerticalAlignment="Center" />
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SecondaryTextBrush}" FontSize="12"
                           VerticalAlignment="Center" DockPanel.Dock="Left" />
            </DockPanel>
        </Border>

        <!-- ═══ Busy Overlay ═══ -->
        <Border Grid.RowSpan="4" Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Style="{StaticResource MaterialDesignCircularProgressBar}"
                             Width="48" Height="48" />
                <TextBlock Text="جاري المعالجة..." Foreground="White" FontSize="16" Margin="0,12,0,0"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</Window>

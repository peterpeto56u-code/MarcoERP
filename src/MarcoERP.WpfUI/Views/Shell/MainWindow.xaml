<Window x:Class="MarcoERP.WpfUI.Views.Shell.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:nav="clr-namespace:MarcoERP.WpfUI.Navigation"
        Title="MarcoERP — نظام إدارة الموارد"
        Height="768" Width="1366"
        MinHeight="600" MinWidth="1024"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Closing="MainWindow_OnClosing"
        FlowDirection="RightToLeft"
        Background="{StaticResource BackgroundBrush}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />

        <Style x:Key="NavButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="10,7" />
            <Setter Property="Margin" Value="4,1" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Height" Value="36" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource SidebarHoverBrush}" />
                </Trigger>
                <DataTrigger Binding="{Binding IsActive}" Value="True">
                    <Setter Property="Background" Value="{StaticResource SidebarHoverBrush}" />
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="TopBarNavButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Visibility" Value="Collapsed" />
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding ItemType}" Value="Item" />
                        <Condition Binding="{Binding IsVisible}" Value="True" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Visibility" Value="Visible" />
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="OpenTabButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
            <Setter Property="Height" Value="34" />
            <Setter Property="MinWidth" Value="140" />
            <Setter Property="MaxWidth" Value="260" />
            <Setter Property="Padding" Value="10,0,4,0" />
            <Setter Property="Margin" Value="2,0,0,0" />
            <Setter Property="Background" Value="#E8ECEF" />
            <Setter Property="Foreground" Value="#37474F" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Border x:Name="TabBorder"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="8,8,0,0"
                                    Padding="{TemplateBinding Padding}"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  VerticalAlignment="Center" />
                            </Border>
                            <!-- Active indicator line at bottom -->
                            <Border x:Name="ActiveIndicator"
                                    Height="2.5" VerticalAlignment="Bottom"
                                    CornerRadius="2,2,0,0"
                                    Background="{StaticResource PrimaryBrush}"
                                    Margin="8,0"
                                    Visibility="Collapsed" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="TabBorder" Property="Background" Value="#DEE2E6" />
                            </Trigger>
                            <DataTrigger Binding="{Binding IsActive}" Value="True">
                                <Setter TargetName="TabBorder" Property="Background" Value="White" />
                                <Setter TargetName="ActiveIndicator" Property="Visibility" Value="Visible" />
                                <Setter Property="Foreground" Value="#1A237E" />
                            </DataTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Tab close button style -->
        <Style x:Key="TabCloseButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="20" />
            <Setter Property="Height" Value="20" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Focusable" Value="False" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="CloseBorder" Background="{TemplateBinding Background}"
                                CornerRadius="4" Width="20" Height="20">
                            <materialDesign:PackIcon Kind="Close" Width="12" Height="12"
                                                     HorizontalAlignment="Center" VerticalAlignment="Center"
                                                     Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="CloseBorder" Property="Background" Value="#D32F2F" />
                                <Setter Property="Foreground" Value="White" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsActive}" Value="True">
                    <Setter Property="Foreground" Value="#90A4AE" />
                </DataTrigger>
                <DataTrigger Binding="{Binding IsActive}" Value="False">
                    <Setter Property="Foreground" Value="#B0BEC5" />
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <DataTemplate x:Key="NavHeaderTemplate" DataType="{x:Type nav:NavigationItem}">
            <TextBlock Text="{Binding Title}"
                       Foreground="{StaticResource MutedTextBrush}" FontSize="12"
                       Margin="10,10,0,2" FontWeight="Bold"
                       Visibility="{Binding DataContext.IsSidebarExpanded,
                                    RelativeSource={RelativeSource AncestorType=Window},
                                    Converter={StaticResource BoolToVisibility}}" />
        </DataTemplate>

        <DataTemplate x:Key="NavSeparatorTemplate" DataType="{x:Type nav:NavigationItem}">
            <Separator Background="#37474F" Margin="16,4"
                       Visibility="{Binding IsVisible, Converter={StaticResource BoolToVisibility}}" />
        </DataTemplate>

        <DataTemplate x:Key="NavItemTemplate" DataType="{x:Type nav:NavigationItem}">
            <Button Style="{StaticResource NavButtonStyle}"
                    Command="{Binding Command}"
                    Visibility="{Binding IsVisible, Converter={StaticResource BoolToVisibility}}"
                    ToolTip="{Binding Title}">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="{Binding IconKind}"
                                             Width="18" Height="18"
                                             VerticalAlignment="Center"
                                             Foreground="{Binding IconBrush}" />
                    <TextBlock Text="{Binding Title}"
                               Margin="8,0,0,0"
                               VerticalAlignment="Center" FontSize="12"
                               TextTrimming="CharacterEllipsis"
                               Visibility="{Binding DataContext.IsSidebarExpanded,
                                            RelativeSource={RelativeSource AncestorType=Window},
                                            Converter={StaticResource BoolToVisibility}}" />
                </StackPanel>
            </Button>
        </DataTemplate>

        <DataTemplate x:Key="TopBarNavItemTemplate" DataType="{x:Type nav:NavigationItem}">
            <Button Style="{StaticResource TopBarNavButtonStyle}"
                    Command="{Binding Command}" HorizontalContentAlignment="Stretch">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="{Binding IconKind}" Width="18" Height="18"
                                             Foreground="{Binding IconBrush}"
                                             VerticalAlignment="Center" />
                    <TextBlock Text="{Binding Title}" Margin="10,0,0,0"
                               VerticalAlignment="Center" FontSize="12" />
                </StackPanel>
            </Button>
        </DataTemplate>

        <nav:NavigationItemTemplateSelector x:Key="NavTemplateSelector"
                                            HeaderTemplate="{StaticResource NavHeaderTemplate}"
                                            SeparatorTemplate="{StaticResource NavSeparatorTemplate}"
                                            ItemTemplate="{StaticResource NavItemTemplate}" />
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Gesture="Ctrl+K" Command="{Binding OpenCommandPaletteCommand}" />
        <KeyBinding Gesture="Ctrl+N" Command="{Binding ExecuteShortcutCommand}" CommandParameter="New" />
        <KeyBinding Gesture="Ctrl+S" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Save" />
        <KeyBinding Gesture="Ctrl+E" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Edit" />
        <KeyBinding Gesture="Ctrl+R" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Refresh" />
        <KeyBinding Gesture="Ctrl+P" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Print" />
        <KeyBinding Gesture="F9" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Post" />
        <KeyBinding Gesture="Esc" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Cancel" />
        <KeyBinding Gesture="Alt+Right" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Next" />
        <KeyBinding Gesture="Alt+Left" Command="{Binding ExecuteShortcutCommand}" CommandParameter="Previous" />
        <KeyBinding Gesture="Ctrl+Tab" Command="{Binding ActivateNextTabCommand}" />
        <KeyBinding Gesture="Ctrl+Shift+Tab" Command="{Binding ActivatePreviousTabCommand}" />
        <KeyBinding Gesture="Ctrl+W" Command="{Binding CloseActiveTabCommand}" />
        <!-- Phase 7B: Hidden Governance trigger -->
        <KeyBinding Gesture="Ctrl+Shift+Alt+G" Command="{x:Null}" />
    </Window.InputBindings>

    <Grid>
        <Grid.ColumnDefinitions>
            <!-- Sidebar (Auto follows Border width animation) -->
            <ColumnDefinition Width="Auto" />
            <!-- Content -->
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- ═══════════════════ SIDEBAR ═══════════════════ -->
        <Border Grid.Column="0" Background="{StaticResource SidebarBrush}" ClipToBounds="True">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Width" Value="210" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsSidebarExpanded}" Value="False">
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Width"
                                                         To="72" Duration="0:0:0.25">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseInOut" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Width"
                                                         To="210" Duration="0:0:0.25">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseInOut" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <DockPanel>
                <!-- Logo Area -->
                <Border DockPanel.Dock="Top" Padding="10,8" Background="#263238">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <materialDesign:PackIcon Kind="Domain" Width="26" Height="26"
                                                 Foreground="White" VerticalAlignment="Center" />
                        <TextBlock Text="MarcoERP" FontSize="17" FontWeight="Bold"
                                   Foreground="White" Margin="8,0,0,0" VerticalAlignment="Center"
                                   FlowDirection="LeftToRight"
                                   Visibility="{Binding DataContext.IsSidebarExpanded,
                                                RelativeSource={RelativeSource AncestorType=Window},
                                                Converter={StaticResource BoolToVisibility}}" />
                    </StackPanel>
                </Border>

                <!-- User Info -->
                <Border DockPanel.Dock="Top" Padding="8,6" Background="#1a252f">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Account" Width="18" Height="18"
                                                 Foreground="#90CAF9" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding CurrentUserDisplay}"
                                   Foreground="{StaticResource SecondaryTextBrush}" FontSize="11" Margin="6,0,0,0"
                                   VerticalAlignment="Center"
                                   Visibility="{Binding DataContext.IsSidebarExpanded,
                                                RelativeSource={RelativeSource AncestorType=Window},
                                                Converter={StaticResource BoolToVisibility}}" />
                    </StackPanel>
                </Border>

                <!-- Sidebar Toggle Button -->
                <Border DockPanel.Dock="Bottom" Padding="4" Background="#1a252f">
                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                            Foreground="{StaticResource SecondaryTextBrush}" Command="{Binding ToggleSidebarCommand}"
                            HorizontalAlignment="Center" ToolTip="طي/بسط القائمة">
                        <materialDesign:PackIcon Kind="Menu" />
                    </Button>
                </Border>

                <!-- Navigation Menu -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding NavigationItems}"
                                  ItemTemplateSelector="{StaticResource NavTemplateSelector}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Margin="0,8,0,0" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <!-- ═══════════════════ MAIN CONTENT AREA ═══════════════════ -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <!-- Top Bar (header row) -->
                <RowDefinition Height="42" />
                <!-- Tab Strip -->
                <RowDefinition Height="38" />
                <!-- Content -->
                <RowDefinition Height="*" />
                <!-- Status Bar -->
                <RowDefinition Height="28" />
            </Grid.RowDefinitions>

            <!-- ═══════════════ TOP HEADER BAR ═══════════════ -->
            <Border Grid.Row="0" Background="White" Padding="16,0"
                    BorderBrush="#E0E0E0" BorderThickness="0,0,0,0">
                <DockPanel>
                    <TextBlock Text="{Binding PageTitle}"
                               FontSize="16" FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Foreground="{StaticResource PrimaryBrush}" />

                    <StackPanel DockPanel.Dock="Left" Orientation="Horizontal"
                                HorizontalAlignment="Left" VerticalAlignment="Center">

                        <materialDesign:PopupBox StaysOpen="False"
                                                 ToolTip="قائمة سريعة" Margin="0,0,12,0">
                            <materialDesign:PopupBox.ToggleContent>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Menu" Width="20" Height="20"
                                                             Foreground="{StaticResource SubtitleBrush}" VerticalAlignment="Center" />
                                    <TextBlock Text="القائمة" Margin="6,0,0,0"
                                               VerticalAlignment="Center" Foreground="{StaticResource StatusTextBrush}" />
                                </StackPanel>
                            </materialDesign:PopupBox.ToggleContent>
                            <Border Background="White" Padding="8" MinWidth="240">
                                <ScrollViewer MaxHeight="360" VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding NavigationItems}"
                                                  ItemTemplate="{StaticResource TopBarNavItemTemplate}" />
                                </ScrollViewer>
                            </Border>
                        </materialDesign:PopupBox>

                        <!-- Search Box (Opens Command Palette) -->
                        <Border Background="{StaticResource BackgroundBrush}" CornerRadius="16" Padding="8,6" Margin="0,0,12,0" MinWidth="200"
                                Cursor="Hand" MouseLeftButtonDown="SearchBox_MouseDown">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Magnify" Width="16" Height="16"
                                                         Foreground="{StaticResource SubtitleBrush}" VerticalAlignment="Center" />
                                <TextBlock Text="بحث سريع... (Ctrl+K)" FontSize="12"
                                           Foreground="{StaticResource MutedTextBrush}"
                                           VerticalAlignment="Center" Margin="6,0,0,0" />
                            </StackPanel>
                        </Border>

                        <!-- Theme Toggle -->
                        <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                                Command="{Binding ToggleThemeCommand}" ToolTip="تبديل المظهر"
                                Foreground="{StaticResource SubtitleBrush}" Margin="4,0">
                            <materialDesign:PackIcon Kind="{Binding ThemeIcon}" Width="20" Height="20" />
                        </Button>

                        <!-- Notifications -->
                        <materialDesign:PopupBox StaysOpen="True"
                                                 IsPopupOpen="{Binding IsNotificationPanelOpen}"
                                                 ToolTip="الإشعارات"
                                                 Margin="4,0" PlacementMode="BottomAndAlignCentres">
                        <materialDesign:PopupBox.ToggleContent>
                            <Grid>
                                <materialDesign:PackIcon Kind="BellOutline" Width="20" Height="20"
                                                         Foreground="{StaticResource SubtitleBrush}" />
                                <Border CornerRadius="8" Background="{StaticResource DangerBrush}"
                                        Width="16" Height="16" HorizontalAlignment="Right"
                                        VerticalAlignment="Top" Margin="0,-4,-6,0"
                                        Visibility="{Binding HasNotifications, Converter={StaticResource BoolToVisibility}}">
                                    <TextBlock Text="{Binding NotificationCount}" FontSize="9"
                                               Foreground="White" HorizontalAlignment="Center"
                                               VerticalAlignment="Center" FontWeight="Bold" />
                                </Border>
                            </Grid>
                        </materialDesign:PopupBox.ToggleContent>
                        <Border Background="White" MinWidth="350" MaxWidth="400" Padding="0">
                            <StackPanel>
                                <Border Background="{StaticResource PrimaryBrush}" Padding="14,10">
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="Bell" Width="18" Height="18"
                                                                 Foreground="White" VerticalAlignment="Center" />
                                        <TextBlock Text="الإشعارات" Foreground="White" FontWeight="SemiBold"
                                                   FontSize="14" Margin="8,0,0,0" VerticalAlignment="Center" />
                                    </StackPanel>
                                </Border>
                                <ScrollViewer MaxHeight="350" VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding Notifications}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="12,10" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <materialDesign:PackIcon Kind="{Binding Icon}" Width="18" Height="18"
                                                                                 Foreground="{StaticResource PrimaryBrush}"
                                                                                 VerticalAlignment="Top" Margin="0,2,8,0" />
                                                        <StackPanel Grid.Column="1">
                                                            <TextBlock Text="{Binding Title}" FontSize="12" FontWeight="SemiBold"
                                                                       TextWrapping="Wrap" />
                                                            <TextBlock Text="{Binding Detail}" FontSize="11"
                                                                       Foreground="{StaticResource MutedTextBrush}"
                                                                       TextTrimming="CharacterEllipsis" MaxWidth="250" />
                                                        </StackPanel>
                                                        <TextBlock Grid.Column="2" Text="{Binding Timestamp}" FontSize="12"
                                                                   Foreground="{StaticResource MutedTextBrush}"
                                                                   VerticalAlignment="Top" FlowDirection="LeftToRight" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                                <!-- Empty state -->
                                <TextBlock Text="لا توجد إشعارات حديثة" FontSize="13"
                                           Foreground="{StaticResource MutedTextBrush}"
                                           HorizontalAlignment="Center" Padding="20"
                                           Visibility="{Binding HasNotifications, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasNotifications}" Value="False">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                        </materialDesign:PopupBox>

                        <!-- Date/Time -->
                        <TextBlock Text="{Binding CurrentDateTime}"
                                   Foreground="{StaticResource SubtitleBrush}" FontSize="12"
                                   VerticalAlignment="Center" FlowDirection="LeftToRight"
                                   Margin="12,0,0,0" />
                    </StackPanel>
                </DockPanel>
            </Border>

            <!-- ═══════════════ PROFESSIONAL TAB STRIP ═══════════════ -->
            <Border Grid.Row="1" Background="#F0F2F5" Padding="6,4,6,0"
                    BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled"
                              Padding="0">
                    <ItemsControl ItemsSource="{Binding OpenTabs}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource OpenTabButtonStyle}"
                                        Command="{Binding DataContext.ActivateTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}">
                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="إغلاق"
                                                      Command="{Binding DataContext.CloseTabCommand, Source={x:Reference Name=MainContent}}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <materialDesign:PackIcon Kind="Close" Width="16" Height="16" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="إغلاق الباقي"
                                                      Command="{Binding DataContext.CloseOtherTabsCommand, Source={x:Reference Name=MainContent}}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <materialDesign:PackIcon Kind="CloseBoxMultipleOutline" Width="16" Height="16" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <Separator />
                                            <MenuItem Header="إغلاق الكل"
                                                      Command="{Binding DataContext.CloseAllTabsCommand, Source={x:Reference Name=MainContent}}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <materialDesign:PackIcon Kind="BookmarkRemoveOutline" Width="16" Height="16" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <!-- Tab Icon -->
                                        <materialDesign:PackIcon Grid.Column="0"
                                                                 Kind="{Binding IconKind}"
                                                                 Width="15" Height="15"
                                                                 VerticalAlignment="Center"
                                                                 Margin="0,0,6,0"
                                                                 Opacity="0.7">
                                            <materialDesign:PackIcon.Style>
                                                <Style TargetType="materialDesign:PackIcon">
                                                    <Setter Property="Foreground" Value="{Binding IconBrush}" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IconBrush}" Value="{x:Null}">
                                                            <Setter Property="Foreground" Value="{StaticResource SubtitleBrush}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </materialDesign:PackIcon.Style>
                                        </materialDesign:PackIcon>
                                        <!-- Tab Title -->
                                        <TextBlock Grid.Column="1" Text="{Binding DisplayTitle}"
                                                   FontSize="13" FontWeight="SemiBold"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   Margin="0,0,8,0" />
                                        <!-- Close Button -->
                                        <Button Grid.Column="2"
                                                Style="{StaticResource TabCloseButtonStyle}"
                                                Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                ToolTip="إغلاق (Ctrl+W)" />
                                    </Grid>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>

            <!-- Content Area -->
            <Border x:Name="MainContent" Grid.Row="2" Padding="8,0,8,8" Background="White">
                <ContentControl Content="{Binding CurrentView}" />
            </Border>

            <!-- Status Bar -->
            <Border Grid.Row="3" Background="#263238" Padding="12,0">
                <DockPanel>
                    <TextBlock Text="{Binding StatusMessage}"
                               Foreground="{StaticResource SecondaryTextBrush}" FontSize="11"
                               VerticalAlignment="Center" />
                    <StackPanel DockPanel.Dock="Left" Orientation="Horizontal"
                                HorizontalAlignment="Left" VerticalAlignment="Center">
                        <TextBlock x:Name="lblVersion" Text="v0.2.0"
                                   Foreground="{StaticResource StatusTextBrush}" FontSize="11"
                                   VerticalAlignment="Center"
                                   FlowDirection="LeftToRight" />
                        <!-- Phase 7B: Hidden governance trigger icon -->
                        <Border x:Name="GovernanceTrigger" Cursor="Hand"
                                Background="Transparent" Padding="4,0" Margin="6,0,0,0"
                                MouseLeftButtonDown="GovernanceTrigger_Click"
                                ToolTip="">
                            <materialDesign:PackIcon Kind="ShieldOutline" Width="12" Height="12"
                                                     Foreground="{StaticResource DarkSurfaceBrush}" Opacity="0.3"
                                                     VerticalAlignment="Center" />
                        </Border>
                    </StackPanel>
                </DockPanel>
            </Border>
        </Grid>

        <!-- ═══════════════════ COMMAND PALETTE OVERLAY ═══════════════════ -->
        <Border Grid.ColumnSpan="2"
                Visibility="{Binding IsCommandPaletteOpen, Converter={StaticResource BoolToVisibility}}"
                Background="{StaticResource OverlayBrush}"
                MouseLeftButtonDown="CommandPaletteOverlay_MouseDown">
            <Border Background="White" CornerRadius="12" Width="500"
                    VerticalAlignment="Top" Margin="0,80,0,0"
                    MaxHeight="450" Padding="0"
                    MouseLeftButtonDown="CommandPaletteInner_MouseDown">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="24" ShadowDepth="4" Opacity="0.3" />
                </Border.Effect>
                <StackPanel>
                    <Border Padding="16,12" Width="490" Height="55">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <materialDesign:PackIcon Kind="Magnify" Width="22" Height="22"
                                                     Foreground="{StaticResource SubtitleBrush}" VerticalAlignment="Center" />
                            <TextBox Grid.Column="1"
                                     Text="{Binding CommandPaletteSearch, UpdateSourceTrigger=PropertyChanged}"
                                     materialDesign:HintAssist.Hint="ابحث عن صفحة أو أمر..."
                                     FontSize="16" BorderThickness="0" Margin="12,0,-2,0"
                                     VerticalAlignment="Center"
                                     x:Name="CommandPaletteSearchBox" />
                        </Grid>
                    </Border>
                    <Separator Margin="0" />
                    <ListBox ItemsSource="{Binding FilteredCommandItems}"
                             MaxHeight="350" BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                        Command="{Binding DataContext.ExecuteCommandPaletteItemCommand, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                        CommandParameter="{Binding}"
                                        HorizontalContentAlignment="Stretch"
                                        Padding="12,8">
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="{Binding IconKind}" Width="20" Height="20"
                                                                 Foreground="{Binding IconBrush}"
                                                                 VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding Title}" Margin="12,0,0,0"
                                                   VerticalAlignment="Center" FontSize="14" />
                                    </StackPanel>
                                </Button>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</Window>

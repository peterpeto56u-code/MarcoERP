<Window x:Class="MarcoERP.WpfUI.Views.Common.InvoiceAddLineWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:common="clr-namespace:MarcoERP.WpfUI.Common"
        Title="إضافة / تعديل بند"
        Width="500" SizeToContent="Height" MaxHeight="640"
        WindowStartupLocation="CenterOwner"
        FlowDirection="RightToLeft"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        FontFamily="Segoe UI"
        TextElement.FontSize="12"
        FocusManager.FocusedElement="{Binding ElementName=cmbProduct}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <Style x:Key="Lbl" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10" />
            <Setter Property="Foreground" Value="#78909C" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="Margin" Value="0,0,0,1" />
        </Style>
        <Style x:Key="Val" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="HorizontalAlignment" Value="Center" />
        </Style>
        <Style x:Key="CompactBox" TargetType="TextBox" BasedOn="{StaticResource MaterialDesignOutlinedTextBox}">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="TextAlignment" Value="Center" />
            <Setter Property="Padding" Value="4,6" />
            <Setter Property="materialDesign:TextFieldAssist.DecorationVisibility" Value="Hidden" />
        </Style>
    </Window.Resources>

    <Border Padding="14,10" Background="White">
        <StackPanel>

            <!-- ═══ Product ═══ -->
            <TextBlock Text="الصنف" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,0,2" />
            <Grid Margin="0,0,0,2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ComboBox x:Name="cmbProduct" Grid.Column="0"
                          ItemsSource="{Binding Products}"
                          SelectedValue="{Binding LinePopup.ProductId, UpdateSourceTrigger=PropertyChanged}"
                          SelectedValuePath="Id" DisplayMemberPath="NameAr"
                          IsEditable="True" TabIndex="0"
                          materialDesign:HintAssist.Hint="الصنف (F1 للبحث)"
                          common:F1SearchBehavior.IsEnabled="True"
                          common:F1SearchBehavior.Title="بحث الأصناف"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          FontSize="13" Height="52"
                          PreviewKeyDown="Field_EnterToNext" />
                <Button Grid.Column="1" Style="{StaticResource MaterialDesignIconForegroundButton}"
                        Click="QuickAddProduct_Click"
                        ToolTip="إضافة صنف سريع"
                        Width="36" Height="36" Margin="4,0,0,0"
                        Foreground="{StaticResource SuccessBrush}">
                    <materialDesign:PackIcon Kind="PlusCircle" Width="22" Height="22" />
                </Button>
            </Grid>
            <!-- Selected product name displayed clearly -->
            <TextBlock Text="{Binding LinePopup.ProductName}" FontSize="14" FontWeight="Bold"
                       Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,6"
                       Visibility="{Binding LinePopup.HasPrimaryUnit, Converter={StaticResource BoolToVis}}" />

            <!-- ═══ Quantities & Prices ═══ -->
            <Border Background="{StaticResource BackgroundBrush}" CornerRadius="5" Padding="10,6" Margin="0,0,0,6"
                    BorderBrush="#E0E0E0" BorderThickness="1">
                <StackPanel>
                    <TextBlock Text="الكمية والوحدات" FontWeight="SemiBold" FontSize="11"
                               Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,4" />

                    <!-- Primary Unit Row (main/registered unit — carton, dozen, etc.) -->
                    <Grid Margin="0,0,0,3"
                          Visibility="{Binding LinePopup.HasPrimaryUnit, Converter={StaticResource BoolToVis}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="70" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="6" />
                            <ColumnDefinition Width="60" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding LinePopup.PrimaryUnitName, StringFormat='{}{0}:'}"
                                   VerticalAlignment="Center" FontSize="11" FontWeight="SemiBold" />
                        <TextBox Grid.Column="1" x:Name="txtPrimaryQty" TabIndex="1"
                                 Text="{Binding LinePopup.PrimaryQty, UpdateSourceTrigger=PropertyChanged, StringFormat=N3}"
                                 Style="{StaticResource CompactBox}"
                                 common:SelectAllOnFocusBehavior.IsEnabled="True"
                                 materialDesign:HintAssist.Hint="الكمية"
                                 PreviewKeyDown="Field_EnterToNext" />
                        <TextBlock Grid.Column="3" Text="السعر:" VerticalAlignment="Center" FontSize="12" />
                        <TextBox Grid.Column="4" x:Name="txtPrimaryPrice" TabIndex="2"
                                 Text="{Binding LinePopup.PrimaryPrice, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}"
                                 Style="{StaticResource CompactBox}"
                                 common:SelectAllOnFocusBehavior.IsEnabled="True"
                                 materialDesign:HintAssist.Hint="{Binding LinePopup.PriceHint}"
                                 PreviewKeyDown="Field_EnterToNext" />
                    </Grid>

                    <!-- Secondary Unit Row (base/smallest unit — piece) -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="70" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="6" />
                            <ColumnDefinition Width="60" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding LinePopup.SecondaryUnitName, StringFormat='{}{0}:'}"
                                   VerticalAlignment="Center" FontSize="11" FontWeight="SemiBold" />
                        <TextBox Grid.Column="1" x:Name="txtSecondaryQty" TabIndex="3"
                                 Text="{Binding LinePopup.SecondaryQty, UpdateSourceTrigger=PropertyChanged, StringFormat=N3}"
                                 Style="{StaticResource CompactBox}"
                                 common:SelectAllOnFocusBehavior.IsEnabled="True"
                                 materialDesign:HintAssist.Hint="الكمية"
                                 PreviewKeyDown="Field_EnterToNext" />
                        <TextBlock Grid.Column="3" Text="السعر:" VerticalAlignment="Center" FontSize="12" />
                        <TextBox Grid.Column="4" x:Name="txtSecondaryPrice" TabIndex="4"
                                 Text="{Binding LinePopup.SecondaryPrice, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}"
                                 Style="{StaticResource CompactBox}"
                                 common:SelectAllOnFocusBehavior.IsEnabled="True"
                                 materialDesign:HintAssist.Hint="{Binding LinePopup.PriceHint}"
                                 PreviewKeyDown="Field_EnterToNext" />
                    </Grid>
                </StackPanel>
            </Border>

            <!-- ═══ Discount ═══ -->
            <Grid Margin="0,0,0,6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="70" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Text="خصم %:" VerticalAlignment="Center" FontSize="11" />
                <TextBox Grid.Column="1" x:Name="txtDiscount" TabIndex="5"
                         Text="{Binding LinePopup.DiscountPercent, UpdateSourceTrigger=PropertyChanged, StringFormat=N1}"
                         Style="{StaticResource CompactBox}"
                         common:SelectAllOnFocusBehavior.IsEnabled="True"
                         PreviewKeyDown="Field_EnterToNext" />
            </Grid>

            <!-- ═══ Reference Info (read-only) ═══ -->
            <Border Background="#F5F7FA" CornerRadius="5" Padding="8,6" Margin="0,0,0,6"
                    BorderBrush="#E8EAF0" BorderThickness="1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="80" />
                        <ColumnDefinition Width="*" MinWidth="80" />
                        <ColumnDefinition Width="*" MinWidth="80" />
                        <ColumnDefinition Width="*" MinWidth="80" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center" Margin="2,0">
                        <TextBlock Text="المخزون" Style="{StaticResource Lbl}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding LinePopup.StockQty, StringFormat=N3}" Style="{StaticResource Val}" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center" Margin="2,0">
                        <TextBlock Text="آخر شراء" Style="{StaticResource Lbl}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding LinePopup.LastPurchasePrice, StringFormat=N2}" Style="{StaticResource Val}" />
                    </StackPanel>
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center" Margin="2,0">
                        <TextBlock Text="م.التكلفة" Style="{StaticResource Lbl}" TextTrimming="CharacterEllipsis" ToolTip="متوسط التكلفة" />
                        <TextBlock Text="{Binding LinePopup.AverageCost, StringFormat=N2}" Style="{StaticResource Val}" />
                    </StackPanel>
                    <StackPanel Grid.Column="3" HorizontalAlignment="Center" Margin="2,0">
                        <TextBlock Text="آخر بيع" Style="{StaticResource Lbl}" TextTrimming="CharacterEllipsis" />
                        <TextBlock Text="{Binding LinePopup.LastSalePrice, StringFormat=N2, TargetNullValue=—}" Style="{StaticResource Val}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ═══ Profit Section (sale mode only) ═══ -->
            <Border CornerRadius="5" Padding="8,6" Margin="0,0,0,6"
                    BorderThickness="1"
                    Visibility="{Binding LinePopup.ShowProfit, Converter={StaticResource BoolToVis}}">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="#F1F8E9" />
                        <Setter Property="BorderBrush" Value="#C8E6C9" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding LinePopup.TotalProfit, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                <Setter Property="Background" Value="#FFF3E0" />
                                <Setter Property="BorderBrush" Value="#FFE0B2" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="ربح الوحدة" Style="{StaticResource Lbl}" />
                        <TextBlock Text="{Binding LinePopup.UnitProfit, StringFormat=N2}" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding LinePopup.UnitProfit, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource DangerBrush}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="الربح الإجمالي" Style="{StaticResource Lbl}" />
                        <TextBlock Text="{Binding LinePopup.TotalProfit, StringFormat=N2}" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding LinePopup.TotalProfit, Converter={StaticResource IsNegativeConverter}}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource DangerBrush}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ═══ Line Total ═══ -->
            <Border Background="{StaticResource PrimaryBrush}" CornerRadius="5" Padding="10,6" Margin="0,0,0,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="1.5*" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="الإجمالي" FontSize="9" Foreground="White" Opacity="0.8" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding LinePopup.LineSubtotal, StringFormat=N2}" FontSize="11" Foreground="White" FontWeight="SemiBold" HorizontalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="الخصم" FontSize="9" Foreground="White" Opacity="0.8" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding LinePopup.LineDiscount, StringFormat=N2}" FontSize="11" Foreground="White" FontWeight="SemiBold" HorizontalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="الضريبة" FontSize="9" Foreground="White" Opacity="0.8" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding LinePopup.LineVat, StringFormat=N2}" FontSize="11" Foreground="White" FontWeight="SemiBold" HorizontalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                        <TextBlock Text="الصافي" FontSize="9" Foreground="White" Opacity="0.8" HorizontalAlignment="Center" />
                        <TextBlock Text="{Binding LinePopup.LineTotal, StringFormat=N2}" FontSize="14" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ═══ Buttons ═══ -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Button Grid.Column="1" x:Name="btnAddAndNext" TabIndex="6"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Background="{StaticResource PrimaryBrush}" Foreground="White"
                        Click="AddAndNext_Click" Margin="3,0" Height="32" Padding="14,0"
                        IsEnabled="{Binding LinePopup.IsValid}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="PlusCircle" Width="14" Height="14" VerticalAlignment="Center" />
                        <TextBlock Text="إضافة والتالي" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                    </StackPanel>
                </Button>
                <Button Grid.Column="2" TabIndex="7"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Background="{StaticResource SuccessBrush}" Foreground="White"
                        Click="AddAndClose_Click" Margin="3,0" Height="32" Padding="14,0"
                        IsEnabled="{Binding LinePopup.IsValid}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Check" Width="14" Height="14" VerticalAlignment="Center" />
                        <TextBlock Text="إضافة وإغلاق" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                    </StackPanel>
                </Button>
                <Button Grid.Column="3" TabIndex="8"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Click="Cancel_Click" Margin="3,0" Height="32" Padding="14,0">
                    <TextBlock Text="إلغاء" FontSize="11" />
                </Button>
            </Grid>

        </StackPanel>
    </Border>
</Window>

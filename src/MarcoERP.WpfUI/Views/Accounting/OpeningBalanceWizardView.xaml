<UserControl x:Class="MarcoERP.WpfUI.Views.Accounting.OpeningBalanceWizardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:MarcoERP.WpfUI.Common"
             FlowDirection="RightToLeft"
             local:LoadedCommandBehavior.Command="{Binding LoadCommand}">

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Title -->
            <RowDefinition Height="Auto" />  <!-- Step Indicator -->
            <RowDefinition Height="Auto" />  <!-- Error bar -->
            <RowDefinition Height="*" />     <!-- Step content -->
            <RowDefinition Height="Auto" />  <!-- Navigation buttons -->
        </Grid.RowDefinitions>

        <!-- ══════ Title ══════ -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <TextBlock Text="معالج الأرصدة الافتتاحية" Style="{StaticResource PageTitle}" />
        </Border>

        <!-- ══════ Step Indicator ══════ -->
        <Border Grid.Row="1" Style="{StaticResource CardPanel}" Padding="16,12" Margin="0,0,0,4">
            <Grid HorizontalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="60" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="60" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Step 1 -->
                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                    <Border Width="36" Height="36" CornerRadius="18" HorizontalAlignment="Center"
                            Background="{Binding IsStep1, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStep1}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource PrimaryBrush}" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Step1Status}" Value="Done">
                                        <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="1" Foreground="White" FontWeight="Bold" FontSize="16"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="السنة المالية" FontSize="11" Margin="0,4,0,0"
                               HorizontalAlignment="Center" Foreground="{StaticResource SubtitleBrush}" />
                </StackPanel>

                <!-- Connector 1-2 -->
                <Border Grid.Column="1" Height="2" VerticalAlignment="Center" Margin="0,0,0,16">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Step1Status}" Value="Done">
                                    <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                </Border>

                <!-- Step 2 -->
                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                    <Border Width="36" Height="36" CornerRadius="18" HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStep2}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource PrimaryBrush}" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Step2Status}" Value="Done">
                                        <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="2" Foreground="White" FontWeight="Bold" FontSize="16"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="إدخال الأرصدة" FontSize="11" Margin="0,4,0,0"
                               HorizontalAlignment="Center" Foreground="{StaticResource SubtitleBrush}" />
                </StackPanel>

                <!-- Connector 2-3 -->
                <Border Grid.Column="3" Height="2" VerticalAlignment="Center" Margin="0,0,0,16">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Step2Status}" Value="Done">
                                    <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                </Border>

                <!-- Step 3 -->
                <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                    <Border Width="36" Height="36" CornerRadius="18" HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStep3}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource PrimaryBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="3" Foreground="White" FontWeight="Bold" FontSize="16"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="مراجعة وترحيل" FontSize="11" Margin="0,4,0,0"
                               HorizontalAlignment="Center" Foreground="{StaticResource SubtitleBrush}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- ══════ Error Bar ══════ -->
        <Border Grid.Row="2" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="10,6" Margin="8,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}"
                           Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- ══════ Step Content ══════ -->
        <Grid Grid.Row="3">

            <!-- ───── Step 1: Select Fiscal Year ───── -->
            <Border Style="{StaticResource CardPanel}" Padding="24"
                    Visibility="{Binding IsStep1, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" MinWidth="400">
                    <materialDesign:PackIcon Kind="CalendarStar" Width="48" Height="48"
                                             HorizontalAlignment="Center" Foreground="{StaticResource PrimaryBrush}"
                                             Margin="0,0,0,16" />
                    <TextBlock Text="اختر السنة المالية" Style="{StaticResource SectionTitle}"
                               HorizontalAlignment="Center" Margin="0,0,0,16" />
                    <TextBlock Text="حدد السنة المالية التي تريد إدخال الأرصدة الافتتاحية لها."
                               Foreground="{StaticResource SubtitleBrush}" FontSize="12" HorizontalAlignment="Center"
                               Margin="0,0,0,24" TextWrapping="Wrap" TextAlignment="Center" />

                    <ComboBox materialDesign:HintAssist.Hint="السنة المالية (F1 للبحث)"
                              materialDesign:HintAssist.IsFloating="True"
                              ItemsSource="{Binding FiscalYears}"
                              SelectedItem="{Binding SelectedFiscalYear, Mode=TwoWay}"
                              DisplayMemberPath="Year" IsEditable="True"
                              local:F1SearchBehavior.IsEnabled="True"
                              local:F1SearchBehavior.Title="بحث سنة مالية"
                              FontSize="15" Padding="8" MinWidth="300"
                              HorizontalAlignment="Center" />

                    <TextBlock Margin="0,12,0,0" FontSize="12" Foreground="{StaticResource MutedTextBrush}"
                               HorizontalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedFiscalYear}" Value="{x:Null}">
                                        <Setter Property="Text" Value="" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <!-- Loading indicator -->
                    <ProgressBar IsIndeterminate="True" Margin="0,16,0,0"
                                 Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </StackPanel>
            </Border>

            <!-- ───── Step 2: Enter Balances ───── -->
            <Border Style="{StaticResource CardPanel}" Padding="12"
                    Visibility="{Binding IsStep2, Converter={StaticResource BooleanToVisibilityConverter}}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                        <TextBlock Text="إدخال الأرصدة الافتتاحية" Style="{StaticResource SectionTitle}" />
                        <TextBlock Text="أدخل أرصدة المدين والدائن لكل حساب. يجب أن يكون المجموع متوازناً."
                                   Foreground="{StaticResource SubtitleBrush}" FontSize="12" Margin="0,4,0,0" />
                    </StackPanel>

                    <!-- Totals Bar -->
                        <Border DockPanel.Dock="Bottom" Background="{StaticResource BackgroundBrush}" CornerRadius="4"
                            Padding="16,8" Margin="0,8,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="ScaleBalance" VerticalAlignment="Center"
                                                         Margin="0,0,6,0">
                                    <materialDesign:PackIcon.Style>
                                        <Style TargetType="materialDesign:PackIcon">
                                            <Setter Property="Foreground" Value="{StaticResource ErrorForegroundBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsBalanced}" Value="True">
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </materialDesign:PackIcon.Style>
                                </materialDesign:PackIcon>
                                <TextBlock VerticalAlignment="Center" FontSize="12" FontWeight="SemiBold">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="غير متوازن" />
                                            <Setter Property="Foreground" Value="{StaticResource ErrorForegroundBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsBalanced}" Value="True">
                                                    <Setter Property="Text" Value="متوازن ✓" />
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>

                            <TextBlock Grid.Column="1" VerticalAlignment="Center" Margin="24,0,8,0"
                                       FontSize="12" Foreground="{StaticResource SubtitleBrush}">
                                <Run Text="إجمالي المدين:" FontWeight="SemiBold" />
                                <Run Text="{Binding TotalDebit, StringFormat=\{0:N2\}, Mode=OneWay}" />
                            </TextBlock>

                            <TextBlock Grid.Column="2" VerticalAlignment="Center" Margin="24,0,8,0"
                                       FontSize="12" Foreground="{StaticResource SubtitleBrush}">
                                <Run Text="إجمالي الدائن:" FontWeight="SemiBold" />
                                <Run Text="{Binding TotalCredit, StringFormat=\{0:N2\}, Mode=OneWay}" />
                            </TextBlock>

                            <TextBlock Grid.Column="3" VerticalAlignment="Center" Margin="24,0,0,0"
                                       FontSize="12" Foreground="{StaticResource ErrorForegroundBrush}"
                                       Visibility="{Binding IsBalanced, Converter={StaticResource InverseBoolToVisConverter}}">
                                <Run Text="الفرق:" FontWeight="SemiBold" />
                                <Run Text="{Binding Difference, StringFormat=\{0:N2\}, Mode=OneWay}" />
                            </TextBlock>
                        </Grid>
                    </Border>

                    <!-- Loading -->
                    <ProgressBar DockPanel.Dock="Top" IsIndeterminate="True" Margin="0,0,0,4"
                                 Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />

                    <!-- DataGrid of Accounts -->
                    <DataGrid ItemsSource="{Binding AccountBalances}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False" CanUserDeleteRows="False"
                              SelectionMode="Single" GridLinesVisibility="Horizontal"
                              FontSize="12" RowHeight="36" ColumnHeaderHeight="40"
                              BorderThickness="0"
                              materialDesign:DataGridAssist.CellPadding="8 4">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="كود الحساب" Width="120"
                                Binding="{Binding AccountCode}" IsReadOnly="True" />
                            <DataGridTextColumn Header="اسم الحساب" Width="*"
                                Binding="{Binding AccountNameAr}" IsReadOnly="True" />
                            <DataGridTextColumn Header="مدين" Width="150"
                                Binding="{Binding DebitAmount, StringFormat=\{0:N2\}, UpdateSourceTrigger=LostFocus}"
                                EditingElementStyle="{StaticResource MaterialDesignDataGridTextColumnEditingStyle}" />
                            <DataGridTextColumn Header="دائن" Width="150"
                                Binding="{Binding CreditAmount, StringFormat=\{0:N2\}, UpdateSourceTrigger=LostFocus}"
                                EditingElementStyle="{StaticResource MaterialDesignDataGridTextColumnEditingStyle}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <!-- ───── Step 3: Review & Post ───── -->
            <Border Style="{StaticResource CardPanel}" Padding="24"
                    Visibility="{Binding IsStep3, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel HorizontalAlignment="Center" MinWidth="500" MaxWidth="700">
                        <materialDesign:PackIcon Kind="CheckDecagram" Width="56" Height="56"
                                                 HorizontalAlignment="Center" Margin="0,0,0,16">
                            <materialDesign:PackIcon.Style>
                                <Style TargetType="materialDesign:PackIcon">
                                    <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPosted}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </materialDesign:PackIcon.Style>
                        </materialDesign:PackIcon>

                        <TextBlock Text="مراجعة الأرصدة الافتتاحية" Style="{StaticResource SectionTitle}"
                                   HorizontalAlignment="Center" Margin="0,0,0,24" />

                        <!-- Summary Card -->
                        <Border Background="{StaticResource BackgroundBrush}" CornerRadius="8" Padding="24" Margin="0,0,0,16">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Row="0" Grid.Column="0" Text="السنة المالية:"
                                           FontWeight="SemiBold" FontSize="14" Margin="0,4" />
                                <TextBlock Grid.Row="0" Grid.Column="1"
                                           Text="{Binding SelectedFiscalYear.Year}"
                                           FontSize="14" Margin="0,4" />

                                <TextBlock Grid.Row="1" Grid.Column="0" Text="تاريخ القيد:"
                                           FontWeight="SemiBold" FontSize="14" Margin="0,4" />
                                <TextBlock Grid.Row="1" Grid.Column="1"
                                           Text="{Binding SelectedFiscalYear.StartDate, StringFormat=\{0:yyyy-MM-dd\}}"
                                           FontSize="14" Margin="0,4" FlowDirection="LeftToRight"
                                           HorizontalAlignment="Right" />

                                <TextBlock Grid.Row="2" Grid.Column="0" Text="إجمالي المدين:"
                                           FontWeight="SemiBold" FontSize="14" Margin="0,4" />
                                <TextBlock Grid.Row="2" Grid.Column="1"
                                           Text="{Binding TotalDebit, StringFormat=\{0:N2\}}"
                                           FontSize="14" Margin="0,4" Foreground="{StaticResource PrimaryBrush}" FontWeight="Bold"
                                           FlowDirection="LeftToRight" HorizontalAlignment="Right" />

                                <TextBlock Grid.Row="3" Grid.Column="0" Text="إجمالي الدائن:"
                                           FontWeight="SemiBold" FontSize="14" Margin="0,4" />
                                <TextBlock Grid.Row="3" Grid.Column="1"
                                           Text="{Binding TotalCredit, StringFormat=\{0:N2\}}"
                                           FontSize="14" Margin="0,4" Foreground="{StaticResource PrimaryBrush}" FontWeight="Bold"
                                           FlowDirection="LeftToRight" HorizontalAlignment="Right" />

                                <TextBlock Grid.Row="4" Grid.Column="0" Text="الحالة:"
                                           FontWeight="SemiBold" FontSize="14" Margin="0,4" />
                                <TextBlock Grid.Row="4" Grid.Column="1" FontSize="14" Margin="0,4"
                                           FontWeight="Bold">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="غير متوازن ✗" />
                                            <Setter Property="Foreground" Value="{StaticResource ErrorForegroundBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsBalanced}" Value="True">
                                                    <Setter Property="Text" Value="متوازن ✓" />
                                                    <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </Border>

                        <!-- Posted Success -->
                        <Border Background="{StaticResource UnsavedWarningBackgroundBrush}" CornerRadius="8" Padding="16" Margin="0,0,0,16"
                                Visibility="{Binding IsPosted, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <materialDesign:PackIcon Kind="CheckCircle" Foreground="{StaticResource SuccessBrush}"
                                                         Width="24" Height="24" VerticalAlignment="Center" />
                            <TextBlock Foreground="{StaticResource SuccessBrush}" FontSize="15" FontWeight="SemiBold"
                                           Margin="8,0,0,0" VerticalAlignment="Center">
                                    <Run Text="تم الترحيل بنجاح — رقم القيد:" />
                                    <Run Text="{Binding PostedJournalNumber, Mode=OneWay}" />
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <!-- Post Button -->
                        <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                Background="{StaticResource SuccessBrush}" Foreground="White"
                                Command="{Binding PostCommand}"
                                HorizontalAlignment="Center" MinWidth="200" Padding="24,10"
                                FontSize="15" Margin="0,8,0,0"
                                Visibility="{Binding IsPosted, Converter={StaticResource InverseBoolToVisConverter}}">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="CheckDecagram" VerticalAlignment="Center" />
                                <TextBlock Text="ترحيل الأرصدة الافتتاحية" Margin="8,0,0,0"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>

                        <!-- Loading -->
                        <ProgressBar IsIndeterminate="True" Margin="0,16,0,0"
                                     Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />

                        <!-- Status Message -->
                        <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SubtitleBrush}" FontSize="12"
                                   HorizontalAlignment="Center" Margin="0,12,0,0"
                                   TextWrapping="Wrap" TextAlignment="Center" />
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- ══════ Navigation Buttons ══════ -->
        <Border Grid.Row="4" Style="{StaticResource CardPanel}" Padding="16,10" Margin="0,4,0,0">
            <DockPanel>
                <!-- Status -->
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SubtitleBrush}" FontSize="12"
                           VerticalAlignment="Center" DockPanel.Dock="Right" Margin="0,0,8,0" />

                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <!-- Back -->
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding BackCommand}" Margin="0,0,8,0"
                            MinWidth="100" Padding="16,6">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ArrowRight" VerticalAlignment="Center" />
                            <TextBlock Text="السابق" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <!-- Next -->
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource PrimaryBrush}" Foreground="White"
                            Command="{Binding NextCommand}" Margin="0,0,8,0"
                            MinWidth="100" Padding="16,6"
                            Visibility="{Binding IsStep3, Converter={StaticResource InverseBoolToVisConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="التالي" Margin="0,0,6,0" VerticalAlignment="Center" />
                            <materialDesign:PackIcon Kind="ArrowLeft" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

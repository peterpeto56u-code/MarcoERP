<UserControl x:Class="MarcoERP.WpfUI.Views.Accounting.JournalEntryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:MarcoERP.WpfUI.Common"
             FlowDirection="RightToLeft"
             local:LoadedCommandBehavior.Command="{Binding LoadCommand}">

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Title + toolbar -->
            <RowDefinition Height="Auto" />  <!-- Error bar -->
            <RowDefinition Height="*" />     <!-- Content -->
            <RowDefinition Height="Auto" />  <!-- Totals + Status -->
        </Grid.RowDefinitions>

        <!-- ══════ Title + Toolbar ══════ -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <DockPanel>
                <TextBlock Text="القيود اليومية" Style="{StaticResource PageTitle}" 
                           DockPanel.Dock="Right" Margin="0" VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource SuccessBrush}" Foreground="White"
                            Command="{Binding NewDraftCommand}" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center" />
                            <TextBlock Text="قيد جديد" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource PrimaryBrush}" Foreground="White"
                            Command="{Binding PostCommand}" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="CheckDecagram" VerticalAlignment="Center" />
                            <TextBlock Text="ترحيل" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding ReverseCommand}" Margin="4,0"
                            Foreground="{StaticResource WarningBrush}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="UndoVariant" VerticalAlignment="Center" />
                            <TextBlock Text="عكس" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                            Command="{Binding DeleteDraftCommand}"
                            Foreground="{StaticResource DangerBrush}" Margin="4,0">
                        <materialDesign:PackIcon Kind="Delete" />
                    </Button>
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="8,4" />
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding LoadCommand}" Margin="4,0">
                        <materialDesign:PackIcon Kind="Refresh" />
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ══════ Error Bar ══════ -->
        <Border Grid.Row="1" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="10,6" Margin="8,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}" 
                           Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- ══════ Main Content ══════ -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="400" />   <!-- Entry list -->
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="1.5*" MinWidth="500" /> <!-- Entry form -->
            </Grid.ColumnDefinitions>

            <!-- ───── Entries List ───── -->
            <Border Grid.Column="0" Style="{StaticResource CardPanel}" Margin="0,0,2,0">
                <DockPanel>
                    <TextBlock Text="قائمة القيود" Style="{StaticResource SectionTitle}" DockPanel.Dock="Top" />
                    <DataGrid ItemsSource="{Binding JournalEntries}"
                              SelectedItem="{Binding SelectedEntry, Mode=TwoWay}"
                              AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              FontSize="12" RowHeight="30" ColumnHeaderHeight="32"
                              BorderThickness="0"
                              materialDesign:DataGridAssist.CellPadding="8 6">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="الرقم" Width="120"
                                Binding="{Binding JournalNumber}" />
                            <DataGridTextColumn Header="المسودة" Width="110"
                                Binding="{Binding DraftCode}" />
                            <DataGridTextColumn Header="التاريخ" Width="90"
                                Binding="{Binding JournalDate, StringFormat=\{0:yyyy-MM-dd\}}" />
                            <DataGridTextColumn Header="الحالة" Width="70"
                                Binding="{Binding Status, Converter={StaticResource StatusToArabicConverter}}" />
                            <DataGridTextColumn Header="الوصف" Width="*"
                                Binding="{Binding Description}" />
                            <DataGridTextColumn Header="مدين" Width="90"
                                Binding="{Binding TotalDebit, StringFormat=\{0:N2\}}" />
                            <DataGridTextColumn Header="دائن" Width="90"
                                Binding="{Binding TotalCredit, StringFormat=\{0:N2\}}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch" />

            <!-- ───── Entry Form / Details ───── -->
            <Border Grid.Column="2" Style="{StaticResource CardPanel}" Margin="2,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Header info -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Status badge -->
                            <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="قيد يومي" Style="{StaticResource SectionTitle}" Margin="0" />
                                <Border CornerRadius="12" Padding="12,4" Margin="12,0,0,0"
                                        Background="{StaticResource InfoBrush}"
                                        Visibility="{Binding SelectedEntry, Converter={StaticResource NullToVisibilityConverter}}">
                                    <TextBlock Text="{Binding SelectedEntryStatus}" 
                                               Foreground="White" FontSize="12" FontWeight="SemiBold" />
                                </Border>
                            </StackPanel>

                            <!-- Date -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,8">
                                <TextBlock Text="التاريخ" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,0,4" />
                                <DatePicker SelectedDate="{Binding FormDate}"
                                            IsEnabled="{Binding IsEditing}"
                                            FontSize="14" FlowDirection="LeftToRight" />
                            </StackPanel>

                            <!-- Reference -->
                            <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,0,8">
                                <TextBlock Text="المرجع" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,0,4" />
                                <TextBox Text="{Binding FormReferenceNumber, UpdateSourceTrigger=PropertyChanged}"
                                         IsEnabled="{Binding IsEditing}"
                                         FontSize="12" Padding="8,6" FlowDirection="LeftToRight" />
                            </StackPanel>

                            <!-- Description -->
                            <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Margin="0,0,0,8">
                                <TextBlock Text="البيان" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,0,0,4" />
                                <TextBox Text="{Binding FormDescription, UpdateSourceTrigger=PropertyChanged}"
                                         IsEnabled="{Binding IsEditing}"
                                         FontSize="14" Padding="8,6"
                                         TextWrapping="Wrap" MinHeight="40" AcceptsReturn="True" />
                            </StackPanel>
                        </Grid>

                        <!-- Lines section -->
                        <DockPanel Margin="0,8,0,0">
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,6">
                                <TextBlock Text="بنود القيد" Style="{StaticResource SectionTitle}" Margin="0"
                                           VerticalAlignment="Center" />
                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                        Command="{Binding AddLineCommand}" Margin="12,0,0,0"
                                        Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        ToolTip="إضافة بند">
                                    <materialDesign:PackIcon Kind="PlusCircle" Foreground="{StaticResource SuccessBrush}" />
                                </Button>
                            </StackPanel>
                            <DataGrid ItemsSource="{Binding FormLines}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False" CanUserDeleteRows="False"
                                      GridLinesVisibility="Horizontal"
                                      FontSize="12" RowHeight="38" ColumnHeaderHeight="36"
                                      BorderThickness="1" BorderBrush="{StaticResource BackgroundBrush}"
                                      materialDesign:DataGridAssist.CellPadding="6 4"
                                      MinHeight="150">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Header="الحساب" Width="*" MinWidth="160">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox ItemsSource="{Binding DataContext.PostableAccounts, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                          SelectedValue="{Binding SelectedAccountId, UpdateSourceTrigger=PropertyChanged}"
                                                          SelectedValuePath="Id"
                                                          DisplayMemberPath="AccountNameAr"
                                                          FontSize="12" Margin="-4,0" IsEditable="True"
                                                          local:F1SearchBehavior.IsEnabled="True"
                                                          local:F1SearchBehavior.Title="بحث حساب"
                                                          IsEnabled="{Binding DataContext.IsEditing, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="مدين" Width="110">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBox Text="{Binding DebitAmount, StringFormat=N2, UpdateSourceTrigger=LostFocus}"
                                                         FlowDirection="LeftToRight" TextAlignment="Right"
                                                         FontSize="12" Padding="4,2" BorderThickness="0"
                                                         IsEnabled="{Binding DataContext.IsEditing, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="دائن" Width="110">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBox Text="{Binding CreditAmount, StringFormat=N2, UpdateSourceTrigger=LostFocus}"
                                                         FlowDirection="LeftToRight" TextAlignment="Right"
                                                         FontSize="12" Padding="4,2" BorderThickness="0"
                                                         IsEnabled="{Binding DataContext.IsEditing, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="بيان البند" Width="140"
                                        Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" />
                                    <DataGridTemplateColumn Header="" Width="40">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                                        Command="{Binding DataContext.RemoveLineCommand, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Visibility="{Binding DataContext.IsEditing, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl},
                                                            Converter={StaticResource BooleanToVisibilityConverter}}"
                                                        Padding="0" Width="28" Height="28">
                                                    <materialDesign:PackIcon Kind="Close" Width="16" Height="16"
                                                                             Foreground="{StaticResource DangerBrush}" />
                                                </Button>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>

                        <!-- Totals -->
                        <Border Background="{StaticResource BackgroundBrush}" CornerRadius="4" Padding="12,8" Margin="0,12,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="✅ القيد متوازن" />
                                            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsBalanced}" Value="False">
                                                    <Setter Property="Text" Value="⚠️ القيد غير متوازن" />
                                                    <Setter Property="Foreground" Value="{StaticResource DangerBrush}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <StackPanel Grid.Column="1" Margin="20,0">
                                    <TextBlock Text="إجمالي المدين" FontSize="11" Foreground="{StaticResource SubtitleBrush}" />
                                    <TextBlock Text="{Binding TotalDebit, StringFormat=\{0:N2\}}"
                                               FontSize="16" FontWeight="Bold" FlowDirection="LeftToRight" />
                                </StackPanel>
                                <StackPanel Grid.Column="2" Margin="20,0">
                                    <TextBlock Text="إجمالي الدائن" FontSize="11" Foreground="{StaticResource SubtitleBrush}" />
                                    <TextBlock Text="{Binding TotalCredit, StringFormat=\{0:N2\}}"
                                               FontSize="16" FontWeight="Bold" FlowDirection="LeftToRight" />
                                </StackPanel>
                                <StackPanel Grid.Column="3" Margin="20,0">
                                    <TextBlock Text="الفرق" FontSize="11" Foreground="{StaticResource SubtitleBrush}" />
                                    <TextBlock Text="{Binding Difference, StringFormat=\{0:N2\}}"
                                               FontSize="16" FontWeight="Bold" FlowDirection="LeftToRight" />
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,12,0,0" HorizontalAlignment="Center"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource PrimaryBrush}" Foreground="White"
                                    Command="{Binding SaveDraftCommand}" Margin="4,0" MinWidth="120">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ContentSave" VerticalAlignment="Center" />
                                    <TextBlock Text="حفظ المسودة" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                    Command="{Binding CancelCommand}" Margin="4,0" MinWidth="80">
                                <TextBlock Text="إلغاء" />
                            </Button>
                        </StackPanel>

                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- ══════ Status Bar ══════ -->
        <Border Grid.Row="3" Padding="10,6" Margin="8,4,8,0">
            <DockPanel>
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SubtitleBrush}" FontSize="12" />
                <ProgressBar IsIndeterminate="{Binding IsBusy}"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Height="3" DockPanel.Dock="Left" Width="100" Margin="16,0,0,0" />
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

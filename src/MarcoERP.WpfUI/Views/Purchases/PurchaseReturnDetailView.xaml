<UserControl x:Class="MarcoERP.WpfUI.Views.Purchases.PurchaseReturnDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:common="clr-namespace:MarcoERP.WpfUI.Common"
             FlowDirection="RightToLeft">

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- ═══ Row 0: Compact Toolbar ═══ -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="8,4" Margin="0,0,0,3">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                            Command="{Binding BackCommand}" ToolTip="العودة للقائمة"
                            Padding="2" Height="28" Width="28" Margin="0,0,4,0">
                        <materialDesign:PackIcon Kind="ArrowRight" Width="16" Height="16" />
                    </Button>
                    <TextBlock Text="مرتجع شراء" FontWeight="Bold" FontSize="16"
                               Foreground="{StaticResource PrimaryBrush}"
                               VerticalAlignment="Center" Margin="0" />
                    <Border CornerRadius="10" Padding="8,2" Margin="8,0,0,0"
                            Visibility="{Binding CurrentReturn, Converter={StaticResource NullToVisibilityConverter}}">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="{StaticResource WarningBrush}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsPosted}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsCancelled}" Value="True">
                                        <Setter Property="Background" Value="{StaticResource DangerBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold"
                                   Text="{Binding CurrentReturn.Status, Converter={StaticResource StatusToArabicConverter}}" />
                    </Border>
                </StackPanel>

                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding EditCommand}" Margin="2,0" Height="28" Padding="8,0"
                            Visibility="{Binding CanEdit, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Pencil" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="تعديل" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource SuccessBrush}" Foreground="White"
                            Command="{Binding SaveCommand}" Margin="2,0" Height="28" Padding="8,0"
                            Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="ContentSave" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="حفظ" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding CancelEditCommand}" Margin="2,0" Height="28" Padding="8,0"
                            Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Cancel" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="إلغاء" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource InfoBrush}" Foreground="White"
                            Command="{Binding PostCommand}" Margin="2,0" Height="28" Padding="8,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="CheckAll" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="ترحيل" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource WarningBrush}" Foreground="White"
                            Command="{Binding CancelReturnCommand}" Margin="2,0" Height="28" Padding="8,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="UndoVariant" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="إلغاء مرتجع" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource DangerBrush}" Foreground="White"
                            Command="{Binding DeleteDraftCommand}" Margin="2,0" Height="28" Padding="8,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Delete" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="حذف" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>

                    <Border CornerRadius="8" Padding="6,1" Margin="6,0,0,0"
                            Background="{StaticResource UnsavedWarningBackgroundBrush}"
                            Visibility="{Binding IsDirty, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="CircleEditOutline" Width="12" Height="12"
                                                     Foreground="{StaticResource UnsavedWarningBrush}" VerticalAlignment="Center" />
                            <TextBlock Text="غير محفوظ" FontSize="12" Foreground="{StaticResource UnsavedWarningBrush}"
                                       Margin="3,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ═══ Row 1: Error Bar ═══ -->
        <Border Grid.Row="1" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="8,4" Margin="0,0,0,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" Width="16" Height="16" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}"
                           Margin="6,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" FontSize="12" />
            </StackPanel>
        </Border>

        <!-- ═══ Row 2: Compact Header — 5 fields in one row ═══ -->
        <Border Grid.Row="2" Style="{StaticResource CardPanel}" Padding="10,6" Margin="0,0,0,3">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" MinWidth="140" />
                    <ColumnDefinition Width="6" />
                    <ColumnDefinition Width="Auto" MinWidth="130" />
                    <ColumnDefinition Width="6" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="6" />
                    <ColumnDefinition Width="Auto" MinWidth="140" />
                    <ColumnDefinition Width="6" />
                    <ColumnDefinition Width="Auto" MinWidth="160" />
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0" materialDesign:HintAssist.Hint="رقم المرتجع"
                         materialDesign:HintAssist.IsFloating="True"
                         Text="{Binding FormNumber}" IsReadOnly="True"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         FontSize="12" Padding="6,4" />
                <DatePicker Grid.Column="2" materialDesign:HintAssist.Hint="التاريخ"
                            materialDesign:HintAssist.IsFloating="True"
                            SelectedDate="{Binding FormDate}" IsEnabled="{Binding IsEditing}"
                            Style="{StaticResource MaterialDesignOutlinedDatePicker}"
                            FontSize="14" Padding="6,4" Width="145" />
                <ComboBox Grid.Column="4" materialDesign:HintAssist.Hint="المورد (F1 للبحث)"
                          materialDesign:HintAssist.IsFloating="True"
                          ItemsSource="{Binding Suppliers}" SelectedValue="{Binding FormSupplierId}"
                          SelectedValuePath="Id" DisplayMemberPath="NameAr"
                          IsEnabled="{Binding IsEditing}" IsEditable="True"
                          common:F1SearchBehavior.IsEnabled="True"
                          common:F1SearchBehavior.Title="بحث الموردين"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          FontSize="12" />
                <ComboBox Grid.Column="6" materialDesign:HintAssist.Hint="المخزن (F1 للبحث)"
                          materialDesign:HintAssist.IsFloating="True"
                          ItemsSource="{Binding Warehouses}" SelectedValue="{Binding FormWarehouseId}"
                          SelectedValuePath="Id" DisplayMemberPath="NameAr"
                          IsEnabled="{Binding IsEditing}" IsEditable="True"
                          common:F1SearchBehavior.IsEnabled="True"
                          common:F1SearchBehavior.Title="بحث المخازن"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          FontSize="12" />
                <ComboBox Grid.Column="8" materialDesign:HintAssist.Hint="الفاتورة الأصلية (اختياري)"
                          materialDesign:HintAssist.IsFloating="True"
                          ItemsSource="{Binding PostedInvoices}" SelectedValue="{Binding FormOriginalInvoiceId}"
                          SelectedValuePath="Id" DisplayMemberPath="InvoiceNumber"
                          IsEnabled="{Binding IsEditing}"
                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                          FontSize="12" />
            </Grid>
        </Border>

        <!-- ═══ Row 3: Return Lines ═══ -->
        <Border Grid.Row="3" Style="{StaticResource CardPanel}" Padding="8,6">
            <DockPanel>
                <Grid DockPanel.Dock="Top" Margin="0,0,0,4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock Text="بنود المرتجع" FontWeight="SemiBold" FontSize="12" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding FormLines.Count, StringFormat='({0})'}" FontSize="11"
                                   Foreground="{StaticResource SubtitleBrush}" VerticalAlignment="Center" Margin="4,0,0,0" />
                    </StackPanel>
                    <Button Grid.Column="2" Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding OpenAddLinePopupCommand}"
                            IsEnabled="{Binding IsEditing}"
                            Background="{StaticResource PrimaryBrush}" Foreground="White"
                            Height="28" Padding="10,0" Margin="0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" Width="14" Height="14" VerticalAlignment="Center" />
                            <TextBlock Text="إضافة بند" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="11" />
                        </StackPanel>
                    </Button>
                </Grid>

                <DataGrid ItemsSource="{Binding FormLines}" AutoGenerateColumns="False"
                          CanUserAddRows="False" CanUserDeleteRows="False"
                          SelectionMode="Single" GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column" FontSize="12"
                          RowHeight="30" ColumnHeaderHeight="30" BorderThickness="1"
                          BorderBrush="#E0E0E0" MinHeight="200"
                          materialDesign:DataGridAssist.CellPadding="6 3"
                          materialDesign:DataGridAssist.ColumnHeaderPadding="6 6"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          IsReadOnly="True">
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Background" Value="Transparent" />
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="الصنف" Width="*" MinWidth="120"
                                            Binding="{Binding ProductName}" IsReadOnly="True" />
                        <DataGridTemplateColumn Header="الوحدة" Width="80" IsReadOnly="True">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding AvailableUnits}"
                                              SelectedValue="{Binding UnitId, Mode=OneWay}"
                                              SelectedValuePath="UnitId" DisplayMemberPath="UnitNameAr"
                                              IsEnabled="False" FontSize="11" BorderThickness="0"
                                              Background="Transparent" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="الكمية" Width="70"
                                            Binding="{Binding Quantity, StringFormat=N3}" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextAlignment" Value="Center" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="السعر" Width="80"
                                            Binding="{Binding UnitPrice, StringFormat=N2}" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextAlignment" Value="Center" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="خصم%" Width="55"
                                            Binding="{Binding DiscountPercent, StringFormat=N1}" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextAlignment" Value="Center" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="الصافي" Width="90"
                                            Binding="{Binding TotalWithVat, StringFormat=N2}" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontWeight" Value="Bold" />
                                    <Setter Property="TextAlignment" Value="Center" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTemplateColumn Header="" Width="30" IsReadOnly="True">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                                            Command="{Binding DataContext.EditLineCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding DataContext.IsEditing, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            Padding="1" Height="22" Width="22" ToolTip="تعديل البند"
                                            Foreground="{StaticResource PrimaryBrush}">
                                        <materialDesign:PackIcon Kind="Pencil" Width="13" Height="13" />
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="" Width="30" IsReadOnly="True">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                                            Command="{Binding DataContext.RemoveLineCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding DataContext.IsEditing, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            Padding="1" Height="22" Width="22" Foreground="{StaticResource DangerBrush}" ToolTip="حذف البند">
                                        <materialDesign:PackIcon Kind="Delete" Width="13" Height="13" />
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
        </Border>

        <!-- ═══ Row 4: Compact Totals Bar ═══ -->
        <Border Grid.Row="4" Background="White" CornerRadius="6" Padding="14,8" Margin="0,3,0,0"
                BorderBrush="#E0E0E0" BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="1.3*" />
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                    <TextBlock Text="الإجمالي" FontSize="12" Foreground="{StaticResource SubtitleBrush}" HorizontalAlignment="Center" Margin="0,0,0,2" />
                    <TextBlock Text="{Binding TotalSubtotal, StringFormat=N2}" FontWeight="SemiBold" FontSize="14" HorizontalAlignment="Center" />
                </StackPanel>
                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                    <TextBlock Text="الخصم" FontSize="12" Foreground="{StaticResource SubtitleBrush}" HorizontalAlignment="Center" Margin="0,0,0,2" />
                    <TextBlock Text="{Binding TotalDiscount, StringFormat=N2}" FontWeight="SemiBold" FontSize="14" Foreground="{StaticResource WarningBrush}" HorizontalAlignment="Center" />
                </StackPanel>
                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                    <TextBlock Text="الضريبة" FontSize="12" Foreground="{StaticResource SubtitleBrush}" HorizontalAlignment="Center" Margin="0,0,0,2" />
                    <TextBlock Text="{Binding TotalVat, StringFormat=N2}" FontWeight="SemiBold" FontSize="14" Foreground="{StaticResource DangerBrush}" HorizontalAlignment="Center" />
                </StackPanel>
                <Border Grid.Column="3" Background="{StaticResource PrimaryBrush}" CornerRadius="6" Padding="12,4" Margin="6,0">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="الصافي" FontSize="12" Foreground="White" Opacity="0.9" HorizontalAlignment="Center" Margin="0,0,0,2" />
                        <TextBlock Text="{Binding TotalNet, StringFormat=N2}" FontWeight="Bold" FontSize="18" Foreground="White" HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ═══ Row 5: Notes + Status Bar ═══ -->
        <Border Grid.Row="5" Background="#ECEFF1" CornerRadius="4" Padding="8,4" Margin="0,3,0,0">
            <DockPanel>
                <TextBox DockPanel.Dock="Right" Width="300"
                         materialDesign:HintAssist.Hint="ملاحظات"
                         materialDesign:HintAssist.IsFloating="False"
                         Text="{Binding FormNotes, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsEditing}"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         FontSize="11" Padding="4,2" Margin="0,0,8,0"
                         MaxHeight="28" />
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource StatusTextBrush}" VerticalAlignment="Center"
                           FontSize="11" DockPanel.Dock="Right" />
                <ProgressBar IsIndeterminate="{Binding IsBusy}" Height="2"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                             DockPanel.Dock="Left" Width="100" VerticalAlignment="Center" Margin="0,0,8,0" />
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

<UserControl x:Class="MarcoERP.WpfUI.Views.Treasury.CashPaymentView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:common="clr-namespace:MarcoERP.WpfUI.Common"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             FlowDirection="RightToLeft">

    <UserControl.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}" />
    </UserControl.InputBindings>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Row 0: Title + Toolbar -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <DockPanel>
                <TextBlock Text="سندات الصرف" Style="{StaticResource PageTitle}"
                           DockPanel.Dock="Right" Margin="0" VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource SuccessBrush}" Foreground="White"
                            Command="{Binding NewCommand}" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center" />
                            <TextBlock Text="جديد" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding LoadCommand}" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Refresh" VerticalAlignment="Center" />
                            <TextBlock Text="تحديث" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="8,4" />
                    <TextBox Width="140" Margin="6,0"
                             materialDesign:HintAssist.Hint="رقم السند"
                             materialDesign:HintAssist.IsFloating="True"
                             Text="{Binding JumpPaymentNumber, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             common:TextBoxEnterCommandBehavior.Command="{Binding JumpToPaymentCommand}" />
                    <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                            Command="{Binding JumpToPaymentCommand}" ToolTip="انتقال" Padding="4"
                            Foreground="{StaticResource PrimaryBrush}">
                        <materialDesign:PackIcon Kind="ArrowRightBold" Width="18" Height="18" />
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Row 1: Error Bar -->
        <Border Grid.Row="1" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="10,6" Margin="8,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}"
                           Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- Row 2: Main Content — List | Splitter | Form -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1.2*" MinWidth="350" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="2*" MinWidth="400" />
            </Grid.ColumnDefinitions>

            <!-- Left: Payments List -->
            <Border Grid.Column="0" Style="{StaticResource CardPanel}">
                <DockPanel>
                    <TextBlock Text="قائمة السندات" Style="{StaticResource SectionTitle}"
                               DockPanel.Dock="Top" Margin="0,0,0,8" />
                    <DataGrid ItemsSource="{Binding Payments}"
                              SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                              AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" CanUserDeleteRows="False"
                              SelectionMode="Single" GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column" FontSize="12"
                              RowHeight="30" ColumnHeaderHeight="32" BorderThickness="0"
                              materialDesign:DataGridAssist.CellPadding="10 6"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="10 8">
                        <DataGrid.InputBindings>
                            <MouseBinding Gesture="LeftDoubleClick" Command="{Binding EditSelectedCommand}" />
                        </DataGrid.InputBindings>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="رقم السند" Binding="{Binding PaymentNumber}" Width="100" />
                            <DataGridTextColumn Header="التاريخ" Binding="{Binding PaymentDate, StringFormat=d}" Width="90" />
                            <DataGridTextColumn Header="الخزنة" Binding="{Binding CashboxName}" Width="90" />
                            <DataGridTextColumn Header="المورد" Binding="{Binding SupplierName}" Width="*" MinWidth="80" />
                            <DataGridTextColumn Header="المبلغ" Binding="{Binding Amount, StringFormat=N2}" Width="90" />
                            <DataGridTextColumn Header="الحالة" Binding="{Binding Status, Converter={StaticResource StatusToArabicConverter}}" Width="70" />
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch" />

            <!-- Right: Payment Form -->
            <Border Grid.Column="2" Style="{StaticResource CardPanel}">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel>
                        <!-- Header: Title + Status Badge -->
                        <DockPanel Margin="0,0,0,8">
                            <TextBlock Style="{StaticResource SectionTitle}" DockPanel.Dock="Right">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0}">
                                        <Binding Path="IsNew" Converter="{StaticResource BoolToNewEditConverter}" />
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <Border DockPanel.Dock="Left" CornerRadius="12" Padding="12,4" Margin="0,0,8,0"
                                    Visibility="{Binding CurrentPayment, Converter={StaticResource NullToVisibilityConverter}}">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="{StaticResource WarningBrush}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPosted}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsCancelled}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource DangerBrush}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold"
                                           Text="{Binding CurrentPayment.Status, Converter={StaticResource StatusToArabicConverter}}" />
                            </Border>
                        </DockPanel>

                        <!-- Payment Number + Date -->
                        <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     materialDesign:HintAssist.Hint="رقم السند"
                                     materialDesign:HintAssist.IsFloating="True"
                                     Text="{Binding FormNumber}" IsReadOnly="True"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}" />
                            <DatePicker Grid.Column="2"
                                        materialDesign:HintAssist.Hint="التاريخ"
                                        materialDesign:HintAssist.IsFloating="True"
                                        SelectedDate="{Binding FormDate}"
                                        IsEnabled="{Binding IsEditing}"
                                        Style="{StaticResource MaterialDesignOutlinedDatePicker}" />
                        </Grid>

                        <!-- Cashbox + Account -->
                        <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <ComboBox Grid.Column="0"
                                      materialDesign:HintAssist.Hint="الخزنة (F1 للبحث)"
                                      materialDesign:HintAssist.IsFloating="True"
                                      ItemsSource="{Binding Cashboxes}"
                                      SelectedValue="{Binding FormCashboxId}"
                                      SelectedValuePath="Id"
                                      DisplayMemberPath="NameAr"
                                      IsEnabled="{Binding IsEditing}" IsEditable="True"
                                      common:F1SearchBehavior.IsEnabled="True"
                                      common:F1SearchBehavior.Title="بحث الصناديق"
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}" />
                            <ComboBox Grid.Column="2"
                                      materialDesign:HintAssist.Hint="الحساب المقابل (F1 للبحث)"
                                      materialDesign:HintAssist.IsFloating="True"
                                      ItemsSource="{Binding PostableAccounts}"
                                      SelectedValue="{Binding FormAccountId}"
                                      SelectedValuePath="Id"
                                      DisplayMemberPath="AccountNameAr"
                                      IsEnabled="{Binding IsEditing}"
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                      IsEditable="True"
                                      common:F1SearchBehavior.IsEnabled="True"
                                      common:F1SearchBehavior.Title="بحث الحسابات" />
                        </Grid>

                        <!-- Supplier (optional) + Amount -->
                        <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <ComboBox Grid.Column="0"
                                      materialDesign:HintAssist.Hint="المورد (اختياري - F1 للبحث)"
                                      materialDesign:HintAssist.IsFloating="True"
                                      ItemsSource="{Binding Suppliers}"
                                      SelectedValue="{Binding FormSupplierId}"
                                      SelectedValuePath="Id"
                                      DisplayMemberPath="NameAr"
                                      IsEnabled="{Binding IsEditing}"
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                      IsEditable="True"
                                      common:F1SearchBehavior.IsEnabled="True"
                                      common:F1SearchBehavior.Title="بحث الموردين" />
                            <TextBox Grid.Column="2"
                                     materialDesign:HintAssist.Hint="المبلغ"
                                     materialDesign:HintAssist.IsFloating="True"
                                     Text="{Binding FormAmount, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}"
                                     IsEnabled="{Binding IsEditing}"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     FontSize="18" FontWeight="Bold"
                                     Foreground="{StaticResource PrimaryBrush}" />
                        </Grid>

                        <!-- Description -->
                        <TextBox materialDesign:HintAssist.Hint="البيان"
                                 materialDesign:HintAssist.IsFloating="True"
                                 Text="{Binding FormDescription, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 Margin="0,4,0,0" />

                        <!-- Notes -->
                        <TextBox materialDesign:HintAssist.Hint="ملاحظات"
                                 materialDesign:HintAssist.IsFloating="True"
                                 Text="{Binding FormNotes, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 Margin="0,8,0,0" AcceptsReturn="True" TextWrapping="Wrap"
                                 MinHeight="50" MaxHeight="80" />

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                    Margin="0,16,0,0">
                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource SuccessBrush}" Foreground="White"
                                    Command="{Binding SaveCommand}" Margin="4,0"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ContentSave" VerticalAlignment="Center" />
                                    <TextBlock Text="حفظ" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>

                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                    Command="{Binding CancelEditCommand}" Margin="4,0"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Cancel" VerticalAlignment="Center" />
                                    <TextBlock Text="إلغاء" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>

                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource InfoBrush}" Foreground="White"
                                    Command="{Binding PostCommand}" Margin="4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="CheckAll" VerticalAlignment="Center" />
                                    <TextBlock Text="ترحيل" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>

                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource WarningBrush}" Foreground="White"
                                    Command="{Binding CancelPaymentCommand}" Margin="4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="UndoVariant" VerticalAlignment="Center" />
                                    <TextBlock Text="إلغاء السند" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>

                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource DangerBrush}" Foreground="White"
                                    Command="{Binding DeleteDraftCommand}" Margin="4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Delete" VerticalAlignment="Center" />
                                    <TextBlock Text="حذف" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>

                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Row 3: Status Bar -->
        <Border Grid.Row="3" Background="#ECEFF1" CornerRadius="4" Padding="10,6" Margin="8,4,8,0">
            <DockPanel>
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource StatusTextBrush}" VerticalAlignment="Center"
                           DockPanel.Dock="Right" />
                <ProgressBar IsIndeterminate="{Binding IsBusy}" Height="3"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                             DockPanel.Dock="Left" Width="120" Margin="0,0,10,0" VerticalAlignment="Center" />
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

<UserControl x:Class="MarcoERP.WpfUI.Views.Treasury.BankReconciliationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             FlowDirection="RightToLeft">

    <UserControl.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}" />
    </UserControl.InputBindings>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- ══════ Title + Toolbar ══════ -->
        <Border Grid.Row="0" Style="{StaticResource CardPanel}" Padding="12,8" Margin="0,0,0,4">
            <DockPanel>
                <TextBlock Text="التسوية البنكية" Style="{StaticResource PageTitle}"
                           DockPanel.Dock="Right" Margin="0" VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" HorizontalAlignment="Left">
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="{StaticResource SuccessBrush}" Foreground="White"
                            Command="{Binding NewCommand}" ToolTip="تسوية جديدة" Margin="4,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center" />
                            <TextBlock Text="تسوية جديدة" Margin="6,0,0,0" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding LoadCommand}" ToolTip="تحديث" Margin="4,0">
                        <materialDesign:PackIcon Kind="Refresh" />
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ══════ Error Bar ══════ -->
        <Border Grid.Row="1" Background="{StaticResource ErrorBackgroundBrush}" CornerRadius="4" Padding="10,6" Margin="8,2"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="AlertCircle" Foreground="{StaticResource ErrorForegroundBrush}" VerticalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource ErrorForegroundBrush}"
                           Margin="8,0,0,0" TextWrapping="Wrap" VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- ══════ Main Content ══════ -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="400" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" MinWidth="400" />
            </Grid.ColumnDefinitions>

            <!-- ───── Reconciliation List ───── -->
            <Border Grid.Column="0" Style="{StaticResource CardPanel}" Margin="0,0,2,0">
                <DockPanel>
                    <TextBlock Text="قائمة التسويات" Style="{StaticResource SectionTitle}" DockPanel.Dock="Top" />

                    <!-- Filter by bank account -->
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,4,0,8">
                        <TextBlock Text="الحساب البنكي:" VerticalAlignment="Center" Margin="0,0,8,0" FontSize="12" />
                        <ComboBox ItemsSource="{Binding BankAccounts}"
                                  SelectedItem="{Binding SelectedBankAccount}"
                                  DisplayMemberPath="NameAr" Width="200" FontSize="12" />
                    </StackPanel>

                    <DataGrid ItemsSource="{Binding AllReconciliations}"
                              SelectedItem="{Binding SelectedReconciliation, Mode=TwoWay}"
                              AutoGenerateColumns="False" IsReadOnly="True"
                              CanUserAddRows="False" CanUserDeleteRows="False"
                              SelectionMode="Single" GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column" FontSize="12"
                              RowHeight="30" ColumnHeaderHeight="32" BorderThickness="0"
                              materialDesign:DataGridAssist.CellPadding="10 6"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="10 8">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="التاريخ" Binding="{Binding ReconciliationDate, StringFormat='yyyy/MM/dd'}" Width="100" />
                            <DataGridTextColumn Header="البنك" Binding="{Binding BankAccountName}" Width="*" />
                            <DataGridTextColumn Header="رصيد الكشف" Binding="{Binding StatementBalance, StringFormat='N2'}" Width="120" />
                            <DataGridTextColumn Header="الفرق" Binding="{Binding Difference, StringFormat='N2'}" Width="100" />
                            <DataGridTemplateColumn Header="مكتملة" Width="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <materialDesign:PackIcon
                                            Kind="{Binding IsCompleted, Converter={StaticResource BoolToCheckIconConverter}}"
                                            Foreground="{Binding IsCompleted, Converter={StaticResource BoolToColorConverter}}"
                                            HorizontalAlignment="Center" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                          HorizontalAlignment="Center" VerticalAlignment="Stretch" />

            <!-- ───── Detail / Form Panel ───── -->
            <Border Grid.Column="2" Style="{StaticResource CardPanel}" Margin="2,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="تفاصيل التسوية" Style="{StaticResource SectionTitle}" />

                        <!-- Bank Account selector (for new) -->
                        <TextBlock Text="الحساب البنكي" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,8,0,4" />
                        <ComboBox ItemsSource="{Binding BankAccounts}"
                                  SelectedValue="{Binding FormBankAccountId}"
                                  SelectedValuePath="Id" DisplayMemberPath="NameAr"
                                  IsEnabled="{Binding IsNew}" FontSize="12" Padding="8,6" />

                        <!-- Date -->
                        <TextBlock Text="تاريخ التسوية" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,12,0,4" />
                        <DatePicker SelectedDate="{Binding FormDate}"
                                    IsEnabled="{Binding IsEditing}" FontSize="12" />

                        <!-- Statement Balance -->
                        <TextBlock Text="رصيد كشف الحساب" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,12,0,4" />
                        <TextBox Text="{Binding FormStatementBalance, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}" FontSize="14" Padding="8,6"
                                 FlowDirection="LeftToRight" />

                        <!-- System Balance (read-only) -->
                        <TextBlock Text="رصيد النظام" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,12,0,4" />
                        <TextBox Text="{Binding FormSystemBalance, StringFormat='N2'}" IsEnabled="False"
                                 FontSize="14" Padding="8,6" FlowDirection="LeftToRight" />

                        <!-- Difference (read-only) -->
                        <TextBlock Text="الفرق" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,12,0,4" />
                        <TextBox Text="{Binding FormDifference, StringFormat='N2'}" IsEnabled="False"
                                 FontSize="16" FontWeight="Bold" Padding="8,6" FlowDirection="LeftToRight"
                                 Foreground="{Binding FormDifferenceColor}" />

                        <!-- Notes -->
                        <TextBlock Text="ملاحظات" FontSize="12" Foreground="{StaticResource SubtitleBrush}" Margin="0,12,0,4" />
                        <TextBox Text="{Binding FormNotes, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}" FontSize="12" Padding="8,6"
                                 TextWrapping="Wrap" AcceptsReturn="True" Height="60" />

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,16,0,0" HorizontalAlignment="Center">
                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource PrimaryBrush}" Foreground="White"
                                    Command="{Binding SaveCommand}"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Margin="4,0" MinWidth="80">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ContentSave" VerticalAlignment="Center" />
                                    <TextBlock Text="حفظ" Margin="6,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                    Command="{Binding CancelCommand}"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Margin="4,0" MinWidth="60">
                                <TextBlock Text="إلغاء" />
                            </Button>
                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource SuccessBrush}" Foreground="White"
                                    Command="{Binding CompleteCommand}" Margin="4,0" MinWidth="80">
                                <TextBlock Text="اكتمال" />
                            </Button>
                            <Button Style="{StaticResource MaterialDesignFlatButton}"
                                    Foreground="{StaticResource DangerBrush}"
                                    Command="{Binding DeleteCommand}" Margin="4,0">
                                <TextBlock Text="حذف" />
                            </Button>
                        </StackPanel>

                        <!-- ── Items Section ── -->
                        <TextBlock Text="بنود التسوية" Style="{StaticResource SectionTitle}" Margin="0,20,0,8" />

                        <!-- Add Item Form -->
                        <Border BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,8"
                                Visibility="{Binding CanAddItems, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <TextBox Grid.Row="0" Grid.Column="0" Margin="0,0,4,4"
                                         Text="{Binding ItemDescription, UpdateSourceTrigger=PropertyChanged}"
                                         materialDesign:HintAssist.Hint="وصف البند" FontSize="12" Padding="6,4" />
                                <TextBox Grid.Row="0" Grid.Column="1" Margin="0,0,4,4"
                                         Text="{Binding ItemAmount, UpdateSourceTrigger=PropertyChanged}"
                                         materialDesign:HintAssist.Hint="المبلغ" FontSize="12" Padding="6,4"
                                         FlowDirection="LeftToRight" />
                                <Button Grid.Row="0" Grid.Column="2" VerticalAlignment="Center"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Background="{StaticResource PrimaryBrush}" Foreground="White"
                                        Command="{Binding AddItemCommand}" MinWidth="60" Padding="8,4">
                                    <materialDesign:PackIcon Kind="Plus" />
                                </Button>

                                <TextBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,0,4,0"
                                         Text="{Binding ItemReference, UpdateSourceTrigger=PropertyChanged}"
                                         materialDesign:HintAssist.Hint="مرجع (اختياري)" FontSize="12" Padding="6,4" />
                            </Grid>
                        </Border>

                        <!-- Items DataGrid -->
                        <DataGrid ItemsSource="{Binding ReconciliationItems}"
                                  AutoGenerateColumns="False" IsReadOnly="True"
                                  CanUserAddRows="False" CanUserDeleteRows="False"
                                  MaxHeight="200" FontSize="12"
                                  RowHeight="30" ColumnHeaderHeight="32" BorderThickness="1"
                                  materialDesign:DataGridAssist.CellPadding="6 4">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="الوصف" Binding="{Binding Description}" Width="*" />
                                <DataGridTextColumn Header="المبلغ" Binding="{Binding Amount, StringFormat='N2'}" Width="100" />
                                <DataGridTextColumn Header="المرجع" Binding="{Binding Reference}" Width="100" />
                                <DataGridTemplateColumn Header="مطابق" Width="50">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <materialDesign:PackIcon
                                                Kind="{Binding IsMatched, Converter={StaticResource BoolToCheckIconConverter}}"
                                                Foreground="{Binding IsMatched, Converter={StaticResource BoolToColorConverter}}"
                                                HorizontalAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- ══════ Status Bar ══════ -->
        <Border Grid.Row="3" Padding="10,6" Margin="8,4,8,0">
            <DockPanel>
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource SubtitleBrush}" FontSize="12" />
                <ProgressBar IsIndeterminate="{Binding IsBusy}"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Height="3" DockPanel.Dock="Left" Width="100" Margin="16,0,0,0" />
            </DockPanel>
        </Border>
    </Grid>
</UserControl>

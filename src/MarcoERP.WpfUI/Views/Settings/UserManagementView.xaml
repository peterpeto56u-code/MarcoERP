<UserControl x:Class="MarcoERP.WpfUI.Views.Settings.UserManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:MarcoERP.WpfUI.Common"
             FlowDirection="RightToLeft" Background="White"
             local:LoadedCommandBehavior.Command="{Binding LoadCommand}">

    <UserControl.InputBindings>
        <KeyBinding Key="Escape" Command="{Binding CancelCommand}" />
    </UserControl.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ── Header ─────────────────────────────────── -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" Padding="20,14">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="إدارة المستخدمين" FontSize="22" FontWeight="Bold" Foreground="White"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="مستخدم جديد" Command="{Binding NewCommand}"
                            Style="{StaticResource MaterialDesignFlatLightBgButton}" Foreground="White" Margin="6,0"/>
                    <Button Content="تحديث" Command="{Binding LoadCommand}"
                            Style="{StaticResource MaterialDesignFlatLightBgButton}" Foreground="White"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ── Content: Grid + Form ───────────────────── -->
        <Grid Grid.Row="1" Margin="14,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="400"/>
            </Grid.ColumnDefinitions>

            <!-- DataGrid -->
            <DataGrid Grid.Column="0" ItemsSource="{Binding AllUsers}" SelectedItem="{Binding SelectedItem}"
                      AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                      SelectionMode="Single" Margin="0,0,10,0"
                      materialDesign:DataGridAssist.CellPadding="10 6"
                      HeadersVisibility="Column" GridLinesVisibility="Horizontal">
                <DataGrid.InputBindings>
                    <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding EditCommand}"/>
                </DataGrid.InputBindings>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="اسم المستخدم" Binding="{Binding Username}" Width="120"/>
                    <DataGridTextColumn Header="الاسم الكامل" Binding="{Binding FullNameAr}" Width="*"/>
                    <DataGridTextColumn Header="الدور" Binding="{Binding RoleNameAr}" Width="120"/>
                    <DataGridTemplateColumn Header="نشط" Width="60">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <materialDesign:PackIcon Kind="{Binding IsActive, Converter={StaticResource BoolToCheckIconConverter}}"
                                                         Foreground="{Binding IsActive, Converter={StaticResource BoolToColorConverter}}"
                                                         Width="18" Height="18" HorizontalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="مقفل" Width="60">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <materialDesign:PackIcon Kind="{Binding IsLocked, Converter={StaticResource BoolToCheckIconConverter}}"
                                                         Foreground="{Binding IsLocked, Converter={StaticResource BoolToColorConverter}}"
                                                         Width="18" Height="18" HorizontalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="آخر دخول" Binding="{Binding LastLoginAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" Width="140"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- Form Panel -->
            <Border Grid.Column="1" Style="{StaticResource CardPanel}" Padding="16">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="بيانات المستخدم" Style="{StaticResource SectionTitle}" Margin="0,0,0,12"/>

                        <!-- Username (only for new) -->
                        <TextBox materialDesign:HintAssist.Hint="اسم المستخدم *"
                                 Text="{Binding FormUsername, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsNew}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,10"/>

                        <!-- Password (only for new) -->
                        <PasswordBox materialDesign:HintAssist.Hint="كلمة المرور *"
                                     Visibility="{Binding IsNew, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     Style="{StaticResource MaterialDesignOutlinedPasswordBox}" Margin="0,0,0,10"
                                     x:Name="PasswordField"/>
                        <PasswordBox materialDesign:HintAssist.Hint="تأكيد كلمة المرور *"
                                     Visibility="{Binding IsNew, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     Style="{StaticResource MaterialDesignOutlinedPasswordBox}" Margin="0,0,0,10"
                                     x:Name="ConfirmPasswordField"/>

                        <TextBox materialDesign:HintAssist.Hint="الاسم الكامل بالعربية *"
                                 Text="{Binding FormFullNameAr, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,10"/>

                        <TextBox materialDesign:HintAssist.Hint="الاسم الكامل بالإنجليزية"
                                 FlowDirection="LeftToRight"
                                 Text="{Binding FormFullNameEn, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,10"/>

                        <TextBox materialDesign:HintAssist.Hint="البريد الإلكتروني"
                                 FlowDirection="LeftToRight"
                                 Text="{Binding FormEmail, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,10"/>

                        <TextBox materialDesign:HintAssist.Hint="رقم الهاتف"
                                 Text="{Binding FormPhone, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{Binding IsEditing}"
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}" Margin="0,0,0,10"/>

                        <ComboBox materialDesign:HintAssist.Hint="الدور *"
                                  ItemsSource="{Binding Roles}"
                                  SelectedValue="{Binding FormRoleId}"
                                  SelectedValuePath="Id"
                                  DisplayMemberPath="NameAr"
                                  IsEnabled="{Binding IsEditing}"
                                  Style="{StaticResource MaterialDesignOutlinedComboBox}" Margin="0,0,0,14"/>

                        <!-- Action Buttons -->
                        <WrapPanel HorizontalAlignment="Center" Margin="0,4">
                            <Button Content="حفظ" Command="{Binding SaveCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Background="{StaticResource SuccessBrush}" Foreground="White" Margin="4" Width="90"/>
                                <Button Content="تعديل" Command="{Binding EditCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Margin="4" Width="90"/>
                            <Button Content="إلغاء" Command="{Binding CancelCommand}"
                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    Margin="4" Width="90"/>
                        </WrapPanel>

                        <Separator Margin="0,10"/>

                        <!-- Account Actions -->
                        <TextBlock Text="إجراءات الحساب" Style="{StaticResource SectionTitle}" Margin="0,4,0,10"/>
                        <WrapPanel HorizontalAlignment="Center">
                            <Button Content="فتح القفل" Command="{Binding UnlockCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource WarningBrush}" Foreground="White" Margin="4" Width="100"/>
                            <Button Content="تعطيل" Command="{Binding DeactivateCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource DangerBrush}" Foreground="White" Margin="4" Width="100"/>
                            <Button Content="تفعيل" Command="{Binding ActivateCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{StaticResource SuccessBrush}" Foreground="White" Margin="4" Width="100"/>
                            <Button Content="إعادة كلمة المرور" Command="{Binding ResetPasswordCommand}"
                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                    Margin="4"/>
                        </WrapPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- ── Status Bar ─────────────────────────────── -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundBrush}" Padding="14,8">
            <Grid>
                <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource PrimaryBrush}"/>
                <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource DangerBrush}"
                           Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}"
                           HorizontalAlignment="Left"/>
                <ProgressBar IsIndeterminate="True" HorizontalAlignment="Right" Width="120"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
